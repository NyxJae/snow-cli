# CurrentTaskPlan - 正式 Web SSE 客户端(sse-client)

## 0. 需求基线(SSoT)

- 核心需求文档: `requirements/全平台网页版Snow SSE客户端需求.md`.
- 本轮重点章节:
  - `2.9 子代理展示规则`.
  - `5. 验收标准清单` 中 `875-876`.
- 本轮后置章节:
  - `2.7 聊天区刷新与焦点保持规则`.
  - `5. 验收标准清单` 中 `874`.
- 协议参考:
  - `docs/usage/zh/20.SSE服务模式.md`.
  - `requirements/SSE客户端适配主代理.md`.

## 1. 本轮目标与范围

### 1.1 本轮必须达成的目标

1. 子代理展示并入聊天主区工具卡片体系,不再依赖独立子代理专门展示区域.
2. 子代理卡片在一次调用生命周期内完成单卡片状态流转:
   - 执行开始时状态为"执行中".
   - 收到最终回复后同一卡片切换为"完成".
3. 子代理卡片信息结构满足 2.9:
   - 始终展示输入任务摘要.
   - 输入任务详情默认折叠.
   - 工作过程区域和子代理回复区域按条件显示,默认折叠.
4. 子代理卡片视觉风格与现有工具卡片一致,仅信息结构体现子代理特性.
5. 验收条目保持结果导向描述,不出现过程性开发记录.

### 1.2 本轮明确不做

- 输入框焦点保持(需求验收 874)后置到下一轮独立任务,不纳入本轮 DoD.
- 不扩展与本轮无关的 Git 视图能力.
- 不新增框架级依赖与全局状态库.

## 2. 架构落地策略(按模块)

### 2.1 `sse-client/src/web/render.js`

- [ ] 统一子代理消息渲染入口到工具卡片流水线,移除独立子代理展示分支.
- [ ] 子代理调用创建卡片时写入:
  - `inputSummary`(必填,可见).
  - `inputDetail`(可选,默认折叠).
- [ ] 子代理结果回填时仅更新同一运行中卡片,禁止新建第二张结果卡片.
- [ ] 条件渲染附加区块:
  - 有工作过程数据才显示"工作过程"折叠区.
  - 有最终回复数据才显示"子代理回复"折叠区.
- [ ] 保持与其他工具卡片一致的标题区,状态徽标和间距体系.

验收口径:

- 单次子代理调用在聊天区只出现 1 张卡片,并从"执行中"流转到"完成".
- 无工作过程或无最终回复时,对应折叠区不出现.

### 2.2 `sse-client/src/web/sse.js`

- [ ] 规范子代理事件到前端消息模型的映射,确保"调用开始"与"最终回复"可关联到同一卡片.
- [ ] 为子代理卡片补齐稳定关联键(调用 id 或等效关联标识),避免并发串卡.
- [ ] 子代理过程事件按时间顺序追加到同一卡片工作过程区,不得污染主代理消息流.

验收口径:

- 并发或交错事件下,子代理结果仍能回填到正确卡片.
- 子代理过程消息顺序与服务端事件顺序一致.

### 2.3 `sse-client/src/web/sessions.js`

- [ ] 会话恢复时保留子代理卡片最小必要结构(输入摘要,状态,附加区块数据).
- [ ] 历史消息重建时复用同一子代理卡片归并规则,避免刷新后拆卡或重复卡.

验收口径:

- 刷新页面或切换会话后,既有子代理卡片状态与区块显示保持一致.

### 2.4 `sse-client/src/web/styles.css`

- [ ] 新增或收敛子代理卡片样式 token,复用现有工具卡片基础样式.
- [ ] 子代理特有区块标题和折叠交互样式与工具卡片风格统一.
- [ ] 移除或废弃独立子代理面板相关样式选择器,避免死样式残留.

验收口径:

- 子代理卡片在桌面端和移动端均无布局溢出或层级错乱.

## 3. 实施顺序(短线执行)

1. 先完成 `sse.js` 子代理事件模型与卡片关联键,锁定数据流.
2. 再完成 `render.js` 单卡片归并,状态流转和条件区块渲染.
3. 再完成 `sessions.js` 会话恢复链路,确保刷新后结构稳定.
4. 最后整理 `styles.css` 并清理独立子代理面板样式残留.
5. 执行 `npm run build` 确保构建通过.

## 4. 风险与约束

- 风险 1: 子代理并发事件导致结果串卡.
  - 对策: 强制使用稳定关联键匹配运行中卡片,并保留兜底匹配顺序.
- 风险 2: 历史会话重建时卡片被拆分为调用卡和结果卡.
  - 对策: 历史重建复用实时归并逻辑,以同一规则构造卡片.
- 风险 3: 独立子代理面板样式残留影响聊天区布局.
  - 对策: 样式层清理无引用选择器并复用工具卡片样式 token.

## 5. 完成定义(DoD)

- [ ] `sse-client` 构建通过.
- [ ] 子代理展示已并入聊天主区工具卡片,不再使用独立子代理展示区域(对应验收 875).
- [ ] 子代理卡片支持"执行中"到"完成"状态流转,并按数据存在性显示"工作过程"和"子代理回复"折叠区(对应验收 876).
- [ ] 子代理卡片视觉风格与工具卡片体系一致,无明显交互割裂.
- [ ] 本轮 DoD 不包含输入框焦点保持(验收 874),该项进入后续独立任务.

## 6. 备注

- 本计划仅服务本轮短线交付,长期架构约束以 `.snow` notebook 蓝图为准.
- 若需求文档更新,本计划必须与 `requirements/全平台网页版Snow SSE客户端需求.md` 同步修订.
- 焦点保持需求已确认后置,待子代理能力交付后单独立项执行.
