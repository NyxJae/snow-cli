# API 渠道冲突合并需求文档

## 背景

当前正在将 upstream/main 合并到本地分支,`source/api` 下 4 个渠道适配器同时出现同类冲突:

1. `source/api/anthropic.ts`
2. `source/api/chat.ts`
3. `source/api/gemini.ts`
4. `source/api/responses.ts`

冲突核心集中在系统提示词参数签名,系统提示词注入策略,主/子代理提示词边界,以及多模态处理链路.

## 本次合并目标

在不破坏本地架构的前提下,吸收 upstream 系统提示词增强能力,形成四个 API 文件一致且可维护的合并结果.

## 本轮硬约束

1. 必须保留 upstream 的多系统提示词数组能力.
2. 主代理和子代理都必须支持多条自定义系统提示词,且能力等价.
3. 上游多条自定义系统提示词增强用于适配特殊中转渠道,该适配目的必须在四个 API 文件中保持一致.
4. 必须保持主代理角色定义提示词与子代理角色定义提示词严格隔离.
5. 主代理与子代理在"可自定义系统提示词"逻辑上必须一致,并兼容 upstream 增强.
6. 主代理和子代理"特殊 user 消息动态插入到上下文靠后位置"能力必须保留.
7. 多模态消息特殊处理必须保留.
8. 本阶段先解决冲突并完成构建通过,不引入与本需求无关的重构.

## 统一合并原则

### A. 必须吸收上游

1. 支持多系统提示词数组输入与处理能力.
2. 主代理与子代理都必须完整支持多条自定义系统提示词.
3. 保持上游在系统提示词处理上的增强语义,并在四个 API 文件行为对齐.
4. 明确多条自定义系统提示词的渠道适配目标: 提升特殊中转渠道兼容性与可控性.

### B. 必须保留本地

1. 主/子代理提示词隔离边界.
2. 特殊 user 消息动态后插机制.
3. 本地多模态兼容增强逻辑(含中转平台兼容路径).
4. 本地主代理/子代理配置体系驱动的提示词装配语义.

### C. 合并策略

1. 以"能力并存"代替"二选一覆盖".
2. 四个 API 文件采用同一优先级模型与同一参数约束,避免行为漂移.
3. 禁止在单一渠道先行引入不兼容签名,导致调用方类型断裂.

## 涉及文件与文件级合并要点

### 1) source/api/anthropic.ts

1. 合并 `customSystemPromptOverride` 多值能力.
2. 保留主/子代理提示词隔离逻辑与子代理独立装配语义.
3. 保留特殊 user 消息后插相关上下文顺序语义.
4. 保留 tool_result 与图片分离的多模态兼容处理.
5. 对齐系统提示词优先级,避免主代理提示词污染子代理链路.

### 2) source/api/chat.ts

1. 与 anthropic.ts 对齐参数与优先级模型.
2. 保留主/子代理提示词隔离和特殊 user 消息后插语义.
3. 吸收多系统提示词数组能力,避免仅单字符串路径.
4. 保留多模态消息转换兼容逻辑.

### 3) source/api/gemini.ts

1. 与 anthropic.ts/chat.ts 对齐系统提示词模型.
2. 合并多系统提示词数组支持,同时保留本地主/子代理隔离.
3. 保留特殊 user 消息后插语义.
4. 保留 Gemini 多模态与工具调用转换中的本地兼容增强.

### 4) source/api/responses.ts

1. 与其余三文件保持同一提示词优先级模型.
2. 合并多系统提示词数组能力,并保证 system/instruction 映射一致.
3. 保留主/子代理隔离与特殊 user 消息后插语义.
4. 保留本地 Response API 多模态特殊处理路径.

## 系统提示词统一优先级(四文件一致)

1. 子代理调用且配置了多条自定义系统提示词 -> 使用子代理多条自定义系统提示词.
2. 子代理调用且无自定义但有子代理角色定义提示词 -> 使用子代理角色定义提示词.
3. 主代理调用且配置了多条自定义系统提示词 -> 使用主代理多条自定义系统提示词.
4. 无自定义系统提示词且允许内置 -> 使用对应代理的角色定义提示词.
5. 主代理与子代理的多条自定义系统提示词处理规则必须一致,仅角色定义来源不同.
6. 特殊 user 消息后插机制始终保留,其位置策略不因系统提示词来源变化而丢失.
7. 多条自定义系统提示词的注入方式需满足特殊中转渠道兼容目标,并在四个 API 文件保持一致语义.

## 数据结构与签名约束

1. 四个 API 适配器对 `customSystemPromptOverride` 的类型定义必须统一支持多值能力.
2. 调用链中的系统提示词变量类型在四文件中保持一致,禁止出现单文件独立类型漂移.
3. 主/子代理上下文字段在四文件参数中语义一致,命名一致.
4. 多模态消息结构映射保持渠道内合法,但策略语义跨渠道一致.

## 验收标准

1. 4 个 API 文件均无 conflict markers.
2. 主/子代理提示词隔离逻辑在 4 个 API 文件中均可追踪.
3. 多系统提示词数组能力在 4 个 API 文件中均生效.
4. 特殊 user 消息后插逻辑未丢失,且顺序语义保持一致.
5. 多模态特殊处理链路未退化.
6. `npm run build` 通过.

## 风险与回滚策略

### 风险

1. 参数类型不一致导致调用层编译错误.
2. 主/子代理提示词串扰导致行为越权.
3. 上下文顺序改变导致模型输出偏差.
4. 多模态映射回退导致中转平台兼容问题复发.

### 回滚策略

1. 每个文件完成后先本地构建验证,再进入下一文件.
2. 若某文件引发连锁类型错误,回退到该文件上一步并重新按统一模型合并.
3. 保留四文件合并前状态快照,以支持按文件回滚.

## 执行顺序

1. 先完成 `anthropic.ts` 作为基准模型.
2. 再按同一模型合并 `chat.ts`.
3. 再合并 `gemini.ts`.
4. 最后合并 `responses.ts`.
5. 清理冲突标记并执行 `npm run build` 验证.
