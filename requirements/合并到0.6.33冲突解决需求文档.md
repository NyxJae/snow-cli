# 合并到 0.6.33 冲突解决需求文档

## 背景

当前正在将 upstream 0.6.33 合并到本地分支,出现 5 个未解决冲突文件.本地分支已在 0.6.32 阶段确立子代理与配置体系,本轮合并采用"方案 1: 本地约束优先 + 吸收上游增量能力".

## 方案选择

- 已确认采用: 方案 1.
- 原则: 以本地架构和硬约束为基线,逐文件吸收 0.6.33 中可兼容的功能增量,避免破坏本地长期改造.

## 本轮硬约束

1. 不引入 agent_analyze,agent_debug.
2. 内置子代理以本地体系为准,保留 builtinSubAgents.ts 架构.
3. 继续保留 editableFileSuffixes 全链路能力.
4. 保持本地主代理/子代理配置与角色组装体系.
5. 仅手动合并冲突,并修复连带逻辑后保证 build 通过.
6. 合并后必须保留"子代理可调用子代理"能力,并落实"直接上级负责制":父子代理链路由直接发起者负责等待和吸收结果,再向上游继续汇报.

## 本轮冲突文件

1. source/hooks/conversation/useChatLogic.ts
2. source/hooks/conversation/useConversation.ts
3. source/mcp/notebook.ts
4. source/ui/components/chat/MessageList.tsx
5. source/utils/execution/subAgentExecutor.ts

## 文件级合并策略

### 1) source/utils/execution/subAgentExecutor.ts

- 采用本地主干逻辑,确保:
  - 子代理 ID 与内置体系不回退到 analyze/debug.
  - editableFileSuffixes 在执行上下文继续生效.
- 吸收上游增量时仅纳入可兼容能力:
  - spawnDepth 限制机制.
  - context_usage token 统计兜底能力.
  - 子代理协作消息机制中可与本地约束共存的部分.
- 若上游文案/可选列表包含 analyze/debug,必须改为本地允许集合.

### 2) source/hooks/conversation/useConversation.ts

- 保留本地 executionContext.editableFileSuffixes 透传.
- 合并上游 sub-agent context usage 缓存逻辑,避免丢失上下文占用展示能力.
- 与 MessageList.tsx 的消息类型定义保持一致.

### 3) source/ui/components/chat/MessageList.tsx

- 采用字段并存策略:
  - 保留本地 subAgentResult.
  - 引入上游 subAgentContextUsage.
- 不做二选一删除,避免下游渲染与状态更新断链.

### 4) source/mcp/notebook.ts

- 合并本地路径规范化/存在性校验与上游 notebook 变更追踪能力.
- notebook-add/update/delete 均需保留快照记录逻辑,支持会话回滚时同步处理.

### 5) source/hooks/conversation/useChatLogic.ts

- 吸收上游 partial rollback + notebook rollback 联动逻辑.
- 保持本地现有消息恢复流程和回滚入口行为一致.

## 新增需求纳入(待你确认后实施)

### 子代理配置系统支持"可调用子代理"

- 目标: 子代理可像主代理一样,配置其可调用的子代理白名单.
- 数据模型: 在 `SubAgent` 增加可选字段 `availableSubAgents?: string[]`.
- 兼容策略:
  - 未配置或空数组时,保持当前行为(不额外限制).
  - 已配置时,仅允许调用白名单中的子代理.
- UI 策略: 在 `SubAgentConfigScreen.tsx` 新增"可调用子代理"选择区,复用主代理多选交互模式.
- 执行策略: 在 `subAgentExecutor.ts` 对 `spawn_sub_agent` 做白名单约束,`send_message_to_agent/query_agents_status` 保持可用.
- 存储策略: 通过现有 `sub-agents.toml` 读写链路透传该可选字段,保持向后兼容.

### 新增连带修改文件(非冲突但实施该需求所需)

1. source/utils/config/subAgentConfig.ts
2. source/ui/pages/SubAgentConfigScreen.tsx
3. source/i18n/types.ts
4. source/i18n/lang/en.ts
5. source/i18n/lang/zh.ts
6. source/i18n/lang/zh-TW.ts
7. source/utils/execution/subAgentExecutor.ts

## 执行顺序

1. 先合 subAgentExecutor.ts.
2. 再合 useConversation.ts + MessageList.tsx.
3. 再合 notebook.ts + useChatLogic.ts.
4. 清理冲突标记并验证无未解决冲突.
5. 运行 npm run build.

## 验收标准

1. 5 个冲突文件无 conflict markers.
2. git diff --name-only --diff-filter=U 为空.
3. git ls-files -u 为空.
4. 不引入 agent_analyze,agent_debug.
5. editableFileSuffixes 链路可追踪且未中断.
6. 子代理可调用子代理链路可用: spawn_sub_agent,send_message_to_agent,query_agents_status 均可进入执行分支.
7. 直接上级负责制有效: 父代理在无 tool_calls 时必须先等待并吸收其 spawned child 结果,再继续给出最终响应.
8. npm run build 通过.
