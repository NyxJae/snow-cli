<!-- # 需求文档

## 1. 项目现状与核心目标

当前项目在主代理与子代理发送给 API 的消息序列里,会额外插入一些特殊 user 消息. 现状是这些特殊 user 固定放在对话开头(紧跟 system 消息之后),导致在长对话中权重被稀释,并可能影响 KV 缓存命中. 本需求希望在不破坏工具调用块的前提下,动态调整这些特殊 user 的插入位置,让它们更接近对话尾部.

待补充证据:

- 注意力权重随位置变化的公开资料
- KV 缓存对前置消息变化的失效机制说明

## 2. 范围与边界

**功能点简述**:

- [ ] 动态插入位置: 以倒数第 3 条附近为目标插入点,遇到工具调用块时向前移动,保证块完整.
- [ ] 统一主代理与子代理: 子代理需补上文件夹笔记,两者都插入 4 类特殊 user,顺序一致.
- [ ] 保持角色定义差异: 主代理与子代理仍使用各自的角色定义配置,只统一插入策略与顺序.
- [ ] 变量命名修正: 主代理与子代理的角色定义变量命名统一为 xxxAgentRole 风格,与系统提示词命名区分.
- [ ] 不改 system 消息位置: system 消息仍保持首条.

**特殊 user 清单与顺序**:

1. Agent 角色定义(主代理来源于主代理配置 mainAgentRole 或 role 命名,子代理来源于 subAgentRole 命名)
2. TODO 列表
3. 有用信息
4. 文件夹笔记

**排除项**:

- 不改变既有角色定义内容,只调整插入位置与顺序.
- 不改变 TODO/有用信息/文件夹笔记的格式化内容.
- 不新增或删除工具调用逻辑,仅保证工具调用块顺序不被打断.

## 3. 举例覆盖需求和边缘情况

- **例 1: 会话开始(无历史)**:
  system, Agent 角色定义, TODO, 有用信息, 文件夹笔记, user, assistant, tool_calls, tool
- **例 2: 多轮对话,存在多个工具调用块**:
  system, user, assistant(tool_calls), tool, assistant(tool_calls), tool, ... , Agent 角色定义, TODO, 有用信息, 文件夹笔记, assistant(tool_calls), tool, user, assistant
- **例 3: 倒数第 3 条位置落在工具调用块中**:
  插入点向前移动到该块之前,保证 assistant(tool_calls)与 tool 相邻.
- **例 4: 特殊 user 列表为空**:
  不插入任何特殊 user,保持原有消息序列.
- **例 5: 子代理角色定义缺失**:
  视为配置错误,子代理不可执行,需要先补齐角色定义后再进入插入流程.
- **例 6: 特殊 user 数量超过 3 条**:
  插入点仍按倒数第 3 条计算,整体插入为一个连续块.

## 4. 需求合理性说明(待补充证据)

- **注意力权重假设**: 越靠近尾部的消息在长对话中更易被模型关注. 需要后续用公开资料或测试结果补证.
- **KV 缓存假设**: 前置消息频繁变化会降低缓存命中率. 需要后续用公开资料或测试结果补证.
- **行为一致性**: 调整插入位置不改变消息内容,理论上不应改变功能逻辑,但需通过对话结果对比验证.

用户补充:
当子代理设定了系统提示词 系统提示词作为 system  最终组装子代理角色定义作为特殊 user 和其他特殊 user一样一起动态调整位置.如果没设置系统提示词 最终组装的子代理角色定义被提升至系统提示词,而且在特殊 user中不要去除,也会作为特殊 user 动态调整位置. 


所有 api 都要效果一致. -->

上述已完成



<!-- 没设置系统提示词时,主代理(子代理)的角色定义(和其拼接的信息等) 应该作为 system
且他们任然是特殊user 消息 一起 动态调整位置 (重复了没问题,因为这些信息重要,重复两次没事) -->

已完成

<!-- 
现在 特殊user 动态调整位置逻辑应该有bug 他们应该 接在 倒数 第3条 tool返回 后

即 
举例1
sys
user
ass
tool
.....

ass
tool
ass
tool (倒数第三条tool返回)
specialuser1
specialuser2
specialuser3
specialuser4
assistant
tool
ass
tool

举例二 (刚开始对话)
sys
user
specialuser1
specialuser2
specialuser3
specialuser4
assistant
tool
 -->
已完成

特殊user的内容刷新不及时,应该每次构建请求体时都刷新内容和位置