# 需求文档: 全平台网页版 Snow SSE 客户端

## 1. 项目现状与核心目标

### 1.1 项目现状

- 当前已有 `source/test/sse-client/` 测试客户端,可作为 SSE 协议和基础交互参考.
- 当前缺少面向日常使用的正式 Web 客户端,尤其缺少多服务端管理,移动端优先布局,以及更完整的会话状态展示.
- 当前 SSE 服务端接口能力已覆盖聊天,会话,审批,提问,TODO,日志事件流等核心场景.
- 当前 SSE 服务端默认无端点鉴权,本需求新增的认证是 Web 入口门禁能力,不是对 SSE 全端点做重鉴权.

### 1.2 核心目标

在项目根目录新增 `sse-client` 正式网页客户端,用于 PC + 手机协同使用.

用户目标如下:

1. PC 上运行网页后,同局域网手机可直接访问使用.
2. 界面深色,简洁,现代,移动端优先.
3. 在网页内可按绝对路径启动和管理多个 Snow SSE 服务.
4. 运行中的服务自动连接并生成 Tab.
5. 每个服务端 Tab 内独立管理会话和聊天上下文.
6. 审批弹窗,提问弹窗,TODO,日志,状态栏等能力完整可用.
7. 新增全局 SSE 认证密码配置,首次登录后浏览器会话内免重复登录.
8. 默认会话为 YOLO 开启,用户可手动关闭,恢复会话后也默认开启.
9. 子代理展示参考 TUI,支持子代理嵌套子代理的树形折叠展示.
10. 支持服务端 Tab 级便捷切换 API Profile 和模型,逻辑参考 TUI.
11. 每个服务端支持基础 Git 功能: 修改区与暂存区互转,文件差异查看,填写提交信息提交.
12. 若服务端项目未初始化 Git 仓库,提供"初始化 Git"按钮.

### 1.3 术语说明(面向非专业用户)

- 服务端: 一个通过 `snow --sse` 启动的 Snow SSE 进程.
- 服务端 Tab: 顶部一个标签页,对应一个运行中的服务端.
- 会话: 某个服务端下的一条聊天历史.
- YOLO: 自动批准模式,开启后可减少审批阻断.
- KV 缓存: 模型推理缓存统计信息,用于观察成本与性能.

## 2. 范围与边界

**功能点简述**:

- [ ] 在根目录新增 `sse-client` 正式 Web 客户端目录(非测试页).
- [ ] 采用深色主题与响应式布局,优先保证手机可用.
- [ ] 提供服务端管理弹窗,支持输入绝对路径并启动 Snow SSE.
- [ ] 启动参数模板为 `绝对路径 + 端口 + 超时`.
- [ ] 端口自动预填并跳过占用端口.
- [ ] 运行中的服务端自动连接并自动生成 Tab.
- [ ] 支持同一项目路径启动多个服务端实例,Tab 名以 `项目名:端口` 区分.
- [ ] 每个服务端 1 个 Tab,Tab 名默认显示项目文件夹名.
- [ ] 每个 Tab 左侧显示最近 5 个会话,支持折叠.
- [ ] 会话管理弹窗支持分页,继续会话,删除会话.
- [ ] 删除会话为永久删除,删除前二次确认.
- [ ] 聊天区支持文本发送,图片发送.
- [ ] 审批请求自动弹窗,问题请求自动弹窗(功能对齐 TUI,操作以按钮为主).
- [ ] 提供常驻 TODO 区(不可折叠),支持滚动查看(聊天视图下).
- [ ] 提供会话日志弹窗,仅展示当前会话 SSE 事件流.
- [ ] 提供会话状态栏,展示完整状态信息(见 2.10).
- [ ] 支持服务端 Tab 级 API Profile 和模型快捷切换,逻辑参考 TUI.
- [ ] 子代理运行中支持"插嘴"消息: 通过下拉框单选目标子代理后发送消息.
- [ ] 默认会话 YOLO 开启,用户可手动关闭,恢复会话后也默认开启.
- [ ] 正式 Web 客户端移除"压缩自定义消息"功能.
- [ ] 提供服务端项目级 Git 基础功能: 修改区 <-> 暂存区,查看文件差异,填写提交信息后提交.
- [ ] 修改区包含"已修改未暂存","未跟踪",以及"已删除未暂存"文件.
- [ ] 若当前服务端项目未初始化 Git 仓库,显示"初始化 Git"按钮.
- [ ] Git 视图与聊天区同级,默认显示聊天区,切换后 Git 视图独占中央主区域,保留顶部 Tab 与左侧会话栏,隐藏聊天消息区,TODO 区,日志按钮与底部状态栏.

### 2.1 文档定位与唯一基线

本文件是"全平台网页版 Snow SSE 客户端"的唯一需求基线(SSoT).

- 与本文件冲突的旧描述,以本文件为准.
- 本文件只定义需求与验收口径,不包含开发计划.

### 2.2 信息架构与布局规则

1. 顶部区域:
   - 横向服务端 Tab.
   - Tab 标题默认为项目目录名.
   - 同名目录冲突时,追加 `:端口`,例如 `api:3003`.
2. 左侧区域(可折叠):
   - 展示当前服务端最近 5 个会话.
   - "最近"定义为按 `lastUpdatedAt` 降序.
   - 底部固定"会话管理"按钮.
3. 中央区域:
   - 聊天视图: 展示聊天主消息流与图片选择,预览,发送区.
   - Git 视图: 展示 Git 主区,包含修改区,暂存区,差异查看区与提交区.
   - 聊天视图与 Git 视图同级,采用切换显示,默认展示聊天视图.
4. TODO 区域:
   - 聊天视图下: 桌面端固定在右侧栏,手机端固定在聊天区下方.
   - 聊天视图下: TODO 区常驻显示,不可折叠或收起,超出区域后仅在 TODO 区内部滚动.
   - 聊天视图下(手机端): TODO 区固定高度约 5 条可视,仅内部滚动,用户不可手动调整高度.
   - Git 视图下: TODO 区隐藏.
5. 日志按钮位置:
   - 固定在聊天视图的当前会话聊天区左下角,Git 视图下隐藏.

### 2.3 本地控制 API 契约(必须明确)

采用 `网页 + 本地 Node 控制 API`.

控制 API 最小契约如下:

1. 服务监听:
   - 与 Web 页面同源提供,便于手机端通过同一地址访问.
2. 端点:
   - `POST /api/auth/login`: 登录 Web 入口.
   - `POST /api/auth/logout`: 登出当前浏览器会话.
   - `GET /api/auth/me`: 查询当前浏览器会话登录态.
   - `GET /api/servers`: 查询运行中服务端列表.
   - `POST /api/servers/start`: 启动服务端.
   - `POST /api/servers/stop`: 停止指定服务端.
   - `POST /api/servers/stop-all`: 停止全部服务端.
3. Auth 请求与返回:
   - `POST /api/auth/login` 请求字段: `password`.
   - `POST /api/auth/login` 密码正确时: `success=true`.
   - `POST /api/auth/login` 密码错误时: HTTP 200 + `success=false,errorCode=invalid_password,message=密码错误`.
   - `POST /api/auth/logout` 成功时: `success=true`.
   - `GET /api/auth/me` 在已登录时: `success=true,data:{isLoggedIn:true}`.
   - `GET /api/auth/me` 在未登录时: HTTP 200 + `success=true,data:{isLoggedIn:false}`.
4. `start` 请求字段:
   - `workDir`: 项目绝对路径.
   - `port`: 启动端口.
   - `timeoutMs`: SSE 超时毫秒数.
5. 统一响应结构:
   - 成功: `success=true`,并返回必要数据.
   - 失败: `success=false`,包含 `errorCode` 和 `message`.
6. 典型错误码:
   - Auth 相关: `invalid_password`.
   - Servers 相关: `invalid_work_dir`,`port_in_use`,`start_failed`,`stop_failed`.

### 2.4 服务端启动参数与端口规则

1. 超时字段使用毫秒单位,字段名为 `timeoutMs`.
2. 超时默认值为 `300000`.
3. 端口默认策略:
   - 无已启动 Snow SSE 时,从 `3000` 开始.
   - 有已启动 Snow SSE 时,从当前最大端口 + 1 开始.
   - 若端口被任意进程占用,继续 +1 直到可用.
4. 端口扫描建议最多尝试 100 次,超出后提示用户手动输入.
5. 并发启动请求处理规则:
   - 多个 `POST /api/servers/start` 请求必须串行处理.
   - 后一个请求必须等待前一个请求完成后,再执行端口扫描与启动.
6. 同一项目支持多开服务端:
   - 允许对同一项目路径启动多个服务端实例.
   - 每个实例独立分配端口,独立显示 Tab.
   - Tab 命名规则: 当同名目录冲突时,追加 `:端口`,例如 `api:3003`,`api:3004`.

### 2.5 连接与服务列表规则

1. 页面加载后自动获取运行中服务端列表.
2. 运行中服务端全部自动连接并创建 Tab.
3. 新启动服务默认自动连接并创建 Tab.
4. 单服务断开不影响其他服务端会话.
5. 服务端选择下拉框移除,服务切换仅通过顶部服务端 Tab 完成.
6. 连接控制区移除"连接 SSE"按钮,保留单一"重连"按钮.
7. 每个服务端 Tab 下连接控制固定为两个按钮:"重连"和"关闭".
8. "停止全部"属于服务管理区,不属于每个 Tab 的连接控制区.

### 2.6 会话管理规则

1. 每个服务端 Tab 的会话独立管理.
2. 左侧仅显示最近 5 个会话.
3. 会话管理弹窗支持分页浏览和继续会话.
4. 删除会话是永久删除.
5. 删除前必须二次确认,明确提示不可恢复.

### 2.7 聊天与事件交互规则

1. 支持文本发送与图片发送.
2. 审批事件自动弹窗,行为参考测试客户端.
3. 用户提问事件自动弹窗,功能对齐 TUI 提问弹窗:
   - 支持单选,多选,可编辑某条选项,自定义输入.
   - 支持取消操作.
   - 网页端以直观按钮交互为主,不要求复刻大量快捷键.
4. 聊天视图下 TODO 区域支持滚动,Git 视图下 TODO 区隐藏.
5. 日志弹窗仅展示当前会话 SSE 事件流.
6. 未知 SSE `event.type` 必须容错忽略,页面不崩溃.

### 2.8 YOLO 默认行为

1. 新建会话默认 YOLO 开启.
2. 恢复历史会话后,该会话也默认 YOLO 开启.
3. 用户可在当前会话手动关闭或重新开启.
4. YOLO 开关是会话内可见状态.
5. 发送消息时,请求体应携带当前会话的 YOLO 状态.

### 2.9 子代理展示规则(参考 TUI)

1. 展示模式采用"标准模式".
2. 当调用子代理时,聊天区内生成一个可滚动的"嵌套子面板".
3. 子面板展示内容:
   - 子代理工作过程.
   - 子代理上下文进度条.
   - 子代理最终返回.
   - 子代理 Usage 最终统计.
4. 子代理可继续调用子代理时,采用树形折叠展示:
   - 默认仅展开当前层.
   - 子层默认折叠,用户可手动展开.
   - 手机上优先保持折叠,避免超长屏.

### 2.10 底部会话状态栏规则(参考 TUI)

状态栏尽量贴近 TUI 的信息密度,但不重复显示主代理名称(主代理由顶部下拉负责).

状态栏必须展示:

1. 当前 API Profile 名称.
2. 上下文使用百分比.
3. 已用 Token / 总 Token.
4. KV 缓存信息(如 Cache Read,Cache Create).
5. 连接状态.
6. YOLO 当前状态.

说明:

- Model 不在状态栏展示.
- Model 也不要求在本网页中单独展示.

### 2.11 服务端 Tab 级 API Profile 和模型切换

1. 切换粒度为服务端 Tab 级.
2. 当前服务端 Tab 切换 API Profile 或模型后:

- 该 Tab 当前会话立即生效.
- 该 Tab 后续新会话也使用新配置.

3. 不影响其他服务端 Tab.
4. 交互参考 TUI:

- 提供便捷切换入口.
- 切换后状态栏即时展示新 Profile.

5. 切换失败时需有明确错误提示,并保持原配置不变.
6. 网页端交互以直观按钮为主,不要求复刻大量键盘快捷键.
7. 当收到 `agent_list` 事件且 `currentAgentId=null` 时:
   - 若 `agents` 非空,前端默认自动选中列表第 1 个主代理.
   - 用户后续仍可手动切换为其他主代理.
   - 若 `agents` 为空,下拉框显示"暂无可用主代理"并禁用.

### 2.12 子代理插嘴消息规则(参考 TUI)

1. 当存在运行中的子代理时,聊天输入区显示"发送目标"下拉框.
2. 下拉框为单选,每次消息只发送给 1 个目标子代理.
3. 用户发送后,消息进入被选中的子代理上下文流.
4. 若当前无运行中的子代理,该下拉框隐藏.
5. 该能力对齐 TUI 的子代理插嘴能力,但网页端以直观按钮和下拉框交互为主.

### 2.13 SSE 认证密码配置与登录口径

1. 配置目录: 仅全局 `~/.snow`.
2. 配置文件: `~/.snow/sse-config.json`.
3. 配置范围: 全局唯一密码,所有项目共用.
4. 密码存储方式: 明文(开发优先).
5. 登录口径:
   - 打开网页先登录.
   - 登录成功后,本次浏览器会话内免重复登录.
   - 浏览器会话结束后,下次重新登录.
6. 边界说明:
   - 本需求认证是 Web 入口登录门禁.
   - 不要求把 SSE 各业务端点改造成逐请求鉴权.
7. 会话行为:
   - 登录成功后,浏览器会话内由 `GET /api/auth/me` 维持与识别登录态.
   - 调用 `POST /api/auth/logout` 后,`GET /api/auth/me` 必须返回 `isLoggedIn=false`.
8. 登录态持久化约束:
   - 登录态必须是浏览器会话级,关闭浏览器会话后应失效.
   - 禁止用 `localStorage` 等跨会话持久化方式长期保存登录态.

### 2.14 多端网络与输入规则

1. PC 端负责运行 Web 与本地控制能力.
2. 手机端通过同局域网访问同一网页地址.
3. 手机端允许手动输入 PC 绝对路径,例如 `F:/Projects/xxx`.

### 2.15 排除项

- 不实现 Electron 或 Tauri 桌面壳.
- 不实现会话软删除或回收站.
- 不新增后端日志查询 API,日志以前端已收事件为准.
- 不做生产级复杂安全体系,当前以开发测试效率优先.
- 不实现测试客户端中的"压缩自定义消息"功能.
  - 测试客户端该功能仅用于调试.
  - 正式 Web 客户端仅允许对当前会话做标准压缩操作.

### 2.16 服务端项目 Git 基础功能规则

1. Git 关联粒度为服务端项目级,每个服务端 Tab 对应 1 个项目目录.
2. 若当前服务端项目未初始化 Git 仓库,Git 视图显示"初始化 Git"按钮.
3. 点击"初始化 Git"后,在该项目目录执行 Git 初始化并立即刷新 Git 状态.
4. Git 视图必须包含:
   - 修改区(包含: 已修改未暂存 + 未跟踪 + 已删除未暂存文件).
   - 暂存区.
   - 文件差异查看入口.
   - 提交信息输入框与提交按钮.
5. 必须支持双向操作:
   - 修改区 -> 暂存区.
   - 暂存区 -> 修改区(撤回暂存).
6. 必须支持文件差异查看:
   - 用户在修改区或暂存区点击文件后可查看差异.
   - 差异查看区根据显示宽度自适应:
     - 宽屏(视口宽度 >= 1200px)优先双列对比展示.
     - 窄屏(视口宽度 < 1200px)自动切换为单列展示.
7. 提交规则:
   - 提交信息必填.
   - 暂存区为空时不允许提交.
   - 提交成功后刷新修改区与暂存区.
8. 视图布局规则:
   - Git 视图与聊天区同级,采用切换显示.
   - 默认展示聊天区.
   - 切换到 Git 视图后,Git 视图独占中央主区域.
   - Git 视图下保留顶部服务端 Tab 与左侧最近会话栏.
   - 在 Git 视图下,聊天消息区,TODO 区,日志按钮与底部状态栏隐藏.

### 2.17 通知提醒机制(红点与弹出式 Tips)

#### 2.17.1 Tab 红点显示规则

1. 服务端 Tab 红点:

   - 当某个服务端下存在需要用户关注的会话时,该服务端 Tab 显示红点.
   - 需要关注的情况包括:
     - 会话有待用户审批的请求.
     - 会话有待用户回复的提问.
   - 红点持续显示直到该服务端下所有待处理事项被处理完毕.

2. 会话 Tab/列表项 红点:

   - 左侧最近会话列表中,需要用户关注的会话标题旁显示红点.
   - 会话管理弹窗中,需要关注的会话同样显示红点标记.
   - 红点触发条件与会话内容相关:
     - 审批请求未处理.
     - 用户提问未回复.
     - 用户提问未回复.
     - 任务完成未查看.

3. 红点状态清除:

- 用户进入对应会话并查看完相关内容后,自动清除该会话红点.
- 用户批准或拒绝审批后,清除审批相关红点.
- 用户回复提问后,清除提问相关红点.

#### 2.17.2 右上角弹出式 Tips 提醒规则

1. 触发条件:

- 当服务端收到需要用户立即关注的事件时,触发右上角弹出式 Tips.
- 触发场景:
- 审批请求到达.
- 用户提问到达.

2. Tips 展示内容:

   - 服务端标识: 显示所属服务端名称(项目文件夹名 + 端口).
   - 会话标识: 显示会话名称或 ID.
   - 提醒类型: 明确标注"需要审批"/"需要回复"/"执行完成".
   - 快捷入口: 点击 Tips 可直接跳转到对应会话.

3. Tips 展示规则:

   - 位置: 页面右上角固定位置堆叠显示.
   - 时长: 默认显示 5 秒后自动消失,鼠标悬停时暂停计时.
   - 数量限制: 最多同时显示 3 个 Tips,新 Tips 以堆叠方式出现.
   - 样式: 深色主题下的高对比度卡片设计,包含关闭按钮.

4. Tips 交互行为:

   - 点击 Tips 卡片: 自动切换到对应服务端 Tab 并打开对应会话.
   - 点击关闭按钮: 立即关闭该 Tips,不影响其他提醒.
   - 多条 Tips 时: 按时间倒序排列,最新的显示在最上方.

5. 防打扰机制:
   - 若用户当前正处于该会话界面且焦点在该会话,不弹出该会话的 Tips.
   - 用户手动关闭某类 Tips 后,5 分钟内同类型的提醒不再弹出(仅保留红点提示).

## 3. 举例覆盖需求和边缘情况

### 例 1: 首次登录与会话内免登录

场景: 用户首次在手机打开网页.

预期:

1. 先显示登录界面.
2. 输入全局 SSE 密码并通过.
3. 同一浏览器会话内刷新页面不再重复登录.
4. 浏览器会话结束后,下次打开重新登录.

### 例 2: 端口自动选择

场景: 当前已占用 `3000`,`3001`,`3002`.

预期:

1. 新服务端默认预填 `3003`.
2. 若 `3003` 被占用,继续递增直到可用.
3. 用户仍可手动修改端口.

### 例 3: 自动连接运行中服务

场景: 页面打开时已存在 2 个运行中 Snow SSE.

预期:

1. 页面自动拉取服务列表.
2. 自动连接两项服务.
3. 顶部自动生成 2 个 Tab.

### 例 4: Tab 同名冲突

场景: 两个不同路径项目都叫 `backend`.

预期:

1. Tab 名显示 `backend:3001`,`backend:3004`.
2. 用户可区分并正确切换.

### 例 5: 最近 5 个会话排序

场景: 一个服务端有 20 个会话.

预期:

1. 左侧只显示 5 个.
2. 按 `lastUpdatedAt` 降序排列.
3. 会话管理弹窗可翻页查看全部.

### 例 6: 恢复会话后的 YOLO 默认状态

场景: 用户从会话管理弹窗点击"继续会话".

预期:

1. 恢复成功后该会话默认 YOLO 为开启.
2. 用户可立即手动关闭.
3. 下一次继续恢复时仍默认开启.

### 例 7: 审批弹窗

场景: 收到敏感命令审批请求.

预期:

1. 自动弹窗展示敏感信息和选项.
2. 用户批准或拒绝后,结果准确回传.

### 例 8: 用户提问弹窗

场景: 服务端请求用户选择答案.

预期:

1. 自动弹窗显示问题与候选项.
2. 支持单选,多选,可编辑某条选项,自定义输入,取消.
3. 网页端使用直观按钮完成选择和提交.
4. 提交后继续执行主流程.

### 例 9: 子代理插嘴消息

场景: 子代理运行中,用户想定向发送一条补充消息.

预期:

1. 输入区出现"发送目标"下拉框.
2. 用户单选 1 个目标子代理.
3. 点击发送后,消息只进入该子代理上下文.

### 例 10: 子代理标准展示

场景: 主代理调用子代理执行任务.

预期:

1. 聊天区出现可滚动子面板.
2. 看到过程信息,上下文进度条,最终结果,Usage.

### 例 11: 子代理嵌套子代理

场景: 子代理 A 再调用子代理 B.

预期:

1. 显示树形层级.
2. 默认只展开 A 当前层.
3. B 层默认折叠,用户可手动展开.

### 例 12: 状态栏关键指标

场景: 用户在会话中观察资源使用.

预期:

1. 可看到 API Profile.
2. 可看到上下文百分比和 Token 总量.
3. 可看到 KV 缓存指标.

### 例 13: 服务端 Tab 级切换 API 和模型

场景: 用户在 `project-a` Tab 切换 API Profile 和模型.

预期:

1. 切换后 `project-a` 当前会话立即使用新配置.
2. `project-a` 后续新会话继承新配置.
3. `project-b` Tab 不受影响,仍保持原配置.
4. 底部状态栏立即显示新 Profile.

### 例 14: 日志查看边界

场景: `project-a` 与 `project-b` 同时运行.

预期:

1. 在 `project-a` 会话点击日志按钮.
2. 弹窗仅显示 `project-a` 当前会话事件.
3. 不混入 `project-b` 事件.

### 例 15: 手机端路径输入

场景: 手机端手动启动新项目.

预期:

1. 用户输入 `F:/Projects/demo`.
2. 提交后服务成功启动并自动连入.
3. 启动失败时展示清晰错误原因.

### 例 16: 单服务异常隔离

场景: 一个服务端断连,另一个服务端正常.

预期:

1. 断连 Tab 显示断连态与重连入口.
2. 其他 Tab 继续可用.

### 例 17: 未初始化 Git 仓库

场景: 用户在一个未初始化 Git 的项目中启动服务端.

预期:

1. 用户切换到 Git 视图后,看到"初始化 Git"按钮.
2. 点击后完成初始化并刷新状态.
3. 初始化成功后显示修改区与暂存区.

### 例 18: 修改区与暂存区互转

场景: 项目中存在已修改文件,未跟踪文件,以及已删除未暂存文件.

预期:

1. 修改区同时显示已修改未暂存文件,未跟踪文件,以及已删除未暂存文件.
2. 用户可将选中文件加入暂存区.
3. 用户可将暂存区文件撤回到修改区.

### 例 19: 查看文件差异

场景: 用户在 Git 视图中检查某个文件变更内容.

预期:

1. 用户点击文件后可查看该文件差异.
2. 差异查看区根据显示宽度自适应:
   - 视口宽度 >= 1200px 时展示双列对比.
   - 视口宽度 < 1200px 时展示单列.
3. 差异视图可读,可滚动,并可返回文件列表.

### 例 20: 填写提交信息并提交

场景: 暂存区已有文件,用户准备提交.

预期:

1. 提交信息为空时,提交按钮不可用或提交被拒绝.
2. 输入提交信息后可提交.
3. 提交成功后刷新修改区与暂存区.

### 例 21: Git 视图与聊天视图切换

场景: 用户在聊天中途切换到 Git 视图查看改动.

预期:

1. 默认进入页面时展示聊天区.
2. 切换到 Git 视图后,Git 视图独占中央主区域.
3. Git 视图下保留顶部服务端 Tab 与左侧最近会话栏.
4. Git 视图下聊天消息区,TODO 区,日志按钮与底部状态栏隐藏.
5. 切回聊天视图后恢复聊天消息区,TODO 区,日志按钮与底部状态栏展示.

### 例 22: 主代理列表无当前选中值

场景: 页面连接建立后收到 `agent_list`,但 `currentAgentId` 为 `null`.

预期:

1. 若 `agents` 列表非空,界面默认自动选中第 1 个主代理.
2. 用户可继续手动切换到其他主代理.
3. 若 `agents` 列表为空,下拉框显示"暂无可用主代理"并禁用.

### 例 23: 并发启动服务端请求

场景: 用户快速连续点击两次"启动服务端".

预期:

1. 控制面按请求顺序串行处理启动请求.
2. 第二个请求等待第一个请求完成后,再进行端口扫描与启动.
3. 两次请求各自返回明确结果,避免端口竞争导致状态混乱.

### 例 24: 登录成功后查询登录态

场景: 用户输入正确密码并登录后,页面主动查询登录态.

预期:

1. `POST /api/auth/login` 返回 `success=true`.
2. 随后调用 `GET /api/auth/me` 返回 `success=true,data:{isLoggedIn:true}`.
3. 用户刷新页面后在同一浏览器会话中保持已登录.

### 例 25: 密码错误与未登录态

场景: 用户输入错误密码后继续访问登录态接口.

预期:

1. `POST /api/auth/login` 返回 HTTP 200 + `success=false,errorCode=invalid_password,message=密码错误`.
2. `GET /api/auth/me` 返回 HTTP 200 + `success=true,data:{isLoggedIn:false}`.
3. 页面保持在登录界面,不进入业务主界面.

### 例 26: 主动登出

场景: 用户在已登录状态点击"退出登录".

预期:

1. `POST /api/auth/logout` 返回 `success=true`.
2. 随后 `GET /api/auth/me` 返回 `success=true,data:{isLoggedIn:false}`.
3. 页面切回登录界面,后续访问需重新登录.

### 例 27: 服务端 Tab 红点显示

场景: `project-a` 服务端下有一个会话收到审批请求,用户当前在 `project-b` 的会话中.

预期:

1. `project-a` 的服务端 Tab 上显示红点.
2. 左侧 `project-a` 的会话列表中,对应会话标题旁显示红点.
3. 用户切换到 `project-a` 后,红点不会立即消失.
4. 用户查看完审批内容并做出批准/拒绝后,该会话红点清除.
5. 若 `project-a` 下所有会话的红点都已清除,服务端 Tab 红点也随之消失.

### 例 28: 右上角弹出式 Tips 提醒

场景: 用户正在 `project-b` 的会话中工作,`project-a` 的另一个会话收到提问请求.

预期:

1. 页面右上角弹出 Tips 卡片.
2. 卡片内容显示:"project-a:3000 - 会话 #123 - 需要回复".
3. Tips 在 5 秒后自动消失,鼠标悬停时暂停计时.
4. 用户点击 Tips 后,自动切换到 `project-a` 的 Tab 并打开会话 #123.
5. 若用户当前正处于会话 #123 界面,则不弹出该会话的 Tips.

### 例 29: 多服务端多会话红点管理

场景: 用户同时运行 `project-a:3000` 和 `project-b:3001` 两个服务端,两个服务端下各有多个会话产生待处理事项.

预期:

1. `project-a:3000` Tab 显示红点,其下会话 A1(审批)和 A2(提问)各显示红点.
2. `project-b:3001` Tab 显示红点,其下会话 B1(提问)显示红点.
3. 右上角按时间顺序弹出 3 条 Tips(最多同时显示 3 个).
4. 用户处理完 A1 的审批后,A1 红点清除,但 `project-a` Tab 红点保留(因 A2 仍有红点).
5. 用户依次处理完所有待办事项后,所有红点清除.

### 例 30: Tips 防打扰机制

场景: 用户在会话 #100 中持续工作,该会话不断收到审批请求.

预期:

1. 由于用户当前正处于会话 #100 且焦点在该会话,不弹出该会话的 Tips.
2. 会话 #100 的红点仍然显示,提醒用户有待审批事项.
3. 用户切换到其他会话或页面失去焦点后,该会话的 Tips 恢复弹出.
4. 用户手动关闭某类 Tips 后,5 分钟内同类提醒不再弹出,仅保留红点提示.

## 4. 制表符布局示意图

以下示意图用于非专业审查,只表达布局关系,不代表像素级 UI 设计.

### 4.1 状态 A: 未登录

    [Web入口]
    ┌──────────────────────────────────────────────┐
    │ Snow SSE Web Client                          │
    │                                              │
    │  登录认证                                     │
    │  Password: [______________]                  │
    │  [登录]                                       │
    │                                              │
    └──────────────────────────────────────────────┘

### 4.2 状态 B: 已登录,无服务端连接(聊天视图,宽屏示意)

    ┌──────────────────────────────────────────────────────────────────────────┐
    │ 顶部Tab栏: [ + 添加服务端 ] [聊天|Git]                                    │
    ├───────────────┬──────────────────────────────────────────────────────────┤
    │ 左侧会话栏     │ 右侧聊天区                                               │
    │ (可折叠)       │ ┌──────────────────────────────────────────────────────┐ │
    │ 最近5会话: 空  │ │ 聊天消息区: [暂无连接,请启动服务端]  TODO区: [空]   │ │
    │ [会话管理]     │ │ 宽屏并排展示,聊天消息区与TODO区按展示比例自适应     │ │
    │               │ │ 底部状态栏: Profile | Context | Token | KV | ...    │ │
    │               │ └──────────────────────────────────────────────────────┘ │
    └───────────────┴──────────────────────────────────────────────────────────┘

### 4.3 状态 C: 多服务端聊天中(聊天视图,宽屏示意)

    ┌──────────────────────────────────────────────────────────────────────────┐
    │ 顶部Tab栏: [api:3000] [admin:3001] [worker:3002] [服务管理] [聊天|Git]    │
    ├───────────────┬──────────────────────────────────────────────────────────┤
    │ 左侧会话栏     │ 右侧聊天区(当前Tab: admin:3001)                          │
    │ 最近5会话      │ ┌──────────────────────────────────────────────────────┐ │
    │ - 会话A        │ │ 聊天消息流,图片预览,输入区,发送按钮                  │ │
    │ - 会话B        │ │ TODO区(可滚动)与聊天消息区宽屏并排,比例自适应        │ │
    │ [会话管理]     │ │ 底部状态栏: Profile=xxx | YOLO=ON | Context=xx% ...  │ │
    │               │ └──────────────────────────────────────────────────────┘ │
    └───────────────┴──────────────────────────────────────────────────────────┘

### 4.4 状态 D: 审批敏感命令弹窗

    ┌──────────────────────────────────────────────────────────────────────────┐
    │ 底层仍是聊天视图布局(冻结输入),右侧聊天区仍含 TODO 区与底部状态栏.         │
    │                                                                          │
    │            ┌────────────────────────────────────────────┐                │
    │            │ 审批敏感命令弹窗                            │                │
    │            │ - 敏感命令说明与风险提示                    │                │
    │            │ - [批准] [拒绝]                             │                │
    │            └────────────────────────────────────────────┘                │
    └──────────────────────────────────────────────────────────────────────────┘

### 4.5 状态 E: 用户提问弹窗(参考 TUI 多选与编辑能力)

    ┌──────────────────────────────────────────────────────────────────────────┐
    │ 底层仍是聊天视图布局(冻结输入),右侧聊天区仍含 TODO 区与底部状态栏.         │
    │                                                                          │
    │            ┌────────────────────────────────────────────┐                │
    │            │ 用户提问弹窗                                │                │
    │            │ - 问题描述                                  │                │
    │            │ - 候选项列表(支持单选/多选)                 │                │
    │            │   [ ] 选项A  [x] 选项B  [ ] 选项C          │                │
    │            │ - 支持编辑某条选项和自定义输入              │                │
    │            │ - [取消] [提交回答]                         │                │
    │            └────────────────────────────────────────────┘                │
    └──────────────────────────────────────────────────────────────────────────┘

### 4.6 状态 F: 子代理嵌套展示(可折叠)

    聊天主区消息流:
    ┌────────────────────────────────────────────────────────────┐
    │ 主代理消息                                                  │
    │ └─ 子代理A [展开]                                           │
    │    ├─ 过程日志(可滚动)                                      │
    │    ├─ Context进度条                                         │
    │    ├─ Usage统计                                             │
    │    └─ 子代理B [折叠,点击展开]                              │
    │       ├─ 过程日志                                            │
    │       └─ 最终返回                                            │
    │ ---------------------------------------------------------- │
    │ TODO区(聊天视图下常驻,可滚动) + 底部状态栏(聊天区组成部分)   │
    └────────────────────────────────────────────────────────────┘

### 4.7 状态 G: 手机竖屏 / 窄屏自适应(聊天视图)

    ┌──────────────────────────────┐
    │ 顶部: [Tab下拉] [服务管理] [聊天|Git] │
    ├──────────────────────────────┤
    │ 聊天主区(全宽)                │
    │ 消息流                         │
    │ 子代理面板(可折叠)             │
    ├──────────────────────────────┤
    │ 输入区 + 发送                  │
    ├──────────────────────────────┤
    │ TODO区(常驻,固定高度≈5条,内部滚动,不可手动调整) │
    ├──────────────────────────────┤
    │ 底部状态栏(聊天区底部,可横向滚动) │
    └──────────────────────────────┘

说明:

- 窄屏下聊天消息区与 TODO 区自动切换为上下堆叠展示.
- 宽屏下聊天消息区与 TODO 区并排展示,并按可用展示比例自适应.

### 4.8 状态 H: Git 视图(与聊天视图平级切换)

    ┌──────────────────────────────────────────────────────────────────────────┐
    │ 顶部Tab栏: [api:3000] [admin:3001] [worker:3002] [服务管理] [聊天|Git]    │
    ├───────────────┬──────────────────────────────────────────────────────────┤
    │ 左侧会话栏(保留)│ Git主区(右侧主区,独占除顶部Tab与左侧会话栏外的主区域)     │
    │ 最近5会话      │ [修改区: 已修改 a.ts, 未跟踪 b.ts] [暂存区: 已暂存 c.ts]   │
    │ [会话管理]     │ [差异查看区: 宽屏双列 / 窄屏单列(自适应)]                  │
    │               │ [提交信息输入框____________________] [提交] [初始化Git]     │
    └───────────────┴──────────────────────────────────────────────────────────┘

说明:

- 通过顶部 [聊天|Git] 在聊天视图与 Git 视图间平级切换.
- 该状态下聊天消息区,TODO 区,日志按钮与底部状态栏隐藏.
- 该状态下仅保留顶部 Tab,左侧会话栏与 Git 相关操作区.

### 4.9 视图切换与自适应规则

1. 默认进入聊天视图.
2. 点击顶部 [Git] 切换到 Git 视图.
3. 点击顶部 [聊天] 切回聊天视图.
4. 聊天视图下:
   - 宽屏: 聊天消息区与 TODO 区并排,按展示比例自适应.
   - 窄屏: 聊天消息区与 TODO 区上下堆叠.
   - 底部状态栏属于聊天区,固定在聊天区底部.
5. Git 视图下:
   - 保留顶部 Tab 与左侧会话栏.
   - 隐藏聊天消息区,TODO 区,日志按钮与底部状态栏.
   - 文件差异查看区按视口宽度切换: >= 1200px 双列,< 1200px 单列.

## 5. 验收标准清单

- [ ] 已在根目录新增 `sse-client` 正式网页客户端目录.
- [ ] PC + 手机在同局域网可正常访问并使用.
- [ ] 可在网页输入绝对路径启动服务端.
- [ ] 服务端列表可查询,可单停,可一键停全部.
- [ ] 运行中服务自动连接并生成 Tab.
- [ ] 多个启动请求并发触发时,`POST /api/servers/start` 按请求顺序串行处理.
- [ ] Tab 与会话隔离正确.
- [ ] 左侧最近 5 个会话按 `lastUpdatedAt` 排序.
- [ ] 会话分页,继续,永久删除(含二次确认)可用.
- [ ] 文本和图片消息发送可用.
- [ ] 审批弹窗和问题弹窗可用.
- [ ] 聊天视图下 TODO 区域常驻且不可折叠,手机端固定高度约 5 条可视并支持内部滚动,且不可手动调整高度.
- [ ] 日志弹窗仅显示当前会话事件流.
- [ ] 新建和恢复会话默认 YOLO 开启,可手动关闭.
- [ ] 子代理标准展示和嵌套折叠展示可用.
- [ ] 服务端 Tab 级 API Profile 和模型快捷切换可用.
- [ ] 收到 `agent_list` 且 `currentAgentId=null` 时,默认自动选中第 1 个主代理(无可用主代理时下拉框禁用).
- [ ] 当前 Tab 切换后,当前会话与后续新会话立即生效,其他 Tab 不受影响.
- [ ] 状态栏展示 API Profile,上下文使用百分比,已用 Token / 总 Token,KV 缓存,连接状态,YOLO 状态.
- [ ] 支持服务端项目级 Git 基础功能: 修改区 <-> 暂存区,文件差异查看,填写提交信息后提交.
- [ ] 修改区包含已修改未暂存文件,未跟踪文件,以及已删除未暂存文件.
- [ ] 文件差异查看区根据显示宽度自适应: 视口宽度 >= 1200px 时宽屏双列,视口宽度 < 1200px 时窄屏单列.
- [ ] 未初始化 Git 的项目显示"初始化 Git"按钮,点击后可完成初始化并刷新状态.
- [ ] Git 视图与聊天区同级,默认展示聊天区,切换到 Git 后独占中央主区域,保留顶部 Tab 与左侧会话栏.
- [ ] Git 视图下聊天消息区,TODO 区,日志按钮与底部状态栏隐藏,切回聊天后恢复展示.
- [ ] `POST /api/auth/login` 密码正确时返回 `success=true`.
- [ ] `POST /api/auth/login` 密码错误时返回 HTTP 200 + `success=false,errorCode=invalid_password,message=密码错误`.
- [ ] `GET /api/auth/me` 在已登录时返回 `success=true,data:{isLoggedIn:true}`,未登录时返回 HTTP 200 + `success=true,data:{isLoggedIn:false}`.
- [ ] `POST /api/auth/logout` 调用成功后,`GET /api/auth/me` 返回 `isLoggedIn=false`.
- [ ] Web 入口登录一次后,浏览器会话内免重复登录.
- [ ] 浏览器会话结束后重新打开页面时,`GET /api/auth/me` 返回 `isLoggedIn=false`.
- [ ] 测试客户端"压缩自定义消息"未出现在正式网页客户端.
- [ ] 未知 SSE 事件可容错,页面不崩溃.

## 6. 相关文档与实现参考

- `source/test/sse-client/`
- `requirements/扩展现有sse.md`
- `requirements/SSE客户端适配主代理.md`
- `docs/usage/zh/20.SSE服务模式.md`

以上文档作为参考,本文件作为正式 Web SSE 客户端的需求基线.
开发验证要求,你可以用 Chrome_devtools系列工具自行打开浏览器,去验证当前阶段的完成情况,最终交出的必须是你用浏览器操控工具访问网页验证后无误的结果


点击左侧的会话列表中的会话 tab 就是继续此会话，会话的历史记录参考一下那个测试客户端和 TUI

聊天记录区,自动置底,如果用户手动滚动到非底部,则不再自动置底,等当用手动滚到了最底部或用户发送了新消息后,再自动置底到最新一条.
输入项目绝对路径的地方改成可输入的下拉框,下拉框里有哪些路径,新加一个配置文件吧,然后在启动和停止全部的后面新加一个按钮保存路径删除的话就不在网页里提供按钮了了，就让用户手动去配置里删除好了
有中断会话按钮 和回退到记录点按钮,回退到的那一条消息,把回退点的消息的原文放到输入框中
用户在主代理工作时也可发送消息 并放入 消息队列,且可撤回编辑参考 tui
子代理工作完后 子代理自己这个弹窗可手动关闭 


现在 sse 客户端整体功能差不多了,但整体界面布局还是有些不好看,操作等不够人性化.特别是聊天记录区的显示和 todo 区的显示.优化下显示效果.用动画显示下当前会话正在工作还是已停止.聊天记录用类似聊天软件那种用户消息在右边助手和工具消息在左边的布局.子代理弹窗也优化下.todo 区也用颜色和图标等展示,并支持树状 todo.底部转换栏也优化下显示.整体界面人性化,风格简洁优美,仍保持深色主题.总之现在功能基本齐了,就是界面和交互体验还可以更上一层楼.
git 简易查看和管理区也要美化
当子代理工作时 应显示子代理弹窗,如果是多个子代理被并行调用了，则显示像卡片形式的，可左右滑动查看.多个子代理工作弹窗
你自行开浏览器检查显示效果