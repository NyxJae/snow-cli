<!-- # 需求文档

## 1. 项目现状与核心目标

当前主代理与子代理已有工具权限配置,但缺少对"可编辑文件类型"的细粒度限制.
本需求目标是新增统一配置字段 `editableFileSuffixes: string[]`,用于限制代理在编辑工具中的可编辑文件后缀范围.
同时,主代理和子代理的 TUI 配置界面需要同步支持该字段,保证非专业用户可配置,可理解,可验证.

## 2. 范围与边界

**功能点简述**:

- [ ] 在主代理配置中新增 `editableFileSuffixes` 字段.
- [ ] 在子代理配置中新增 `editableFileSuffixes` 字段.
- [ ] 本需求 MUST ONLY 作用于以下两个编辑工具:
  - `filesystem-edit`
  - `filesystem-edit_search`
- [ ] 编辑工具执行前先检查目标文件后缀是否在允许范围内.
- [ ] 若不在允许范围内,拒绝该文件编辑并返回固定提示.
- [ ] 主代理和子代理的 TUI 配置界面都要支持该字段的输入,展示与保存.

**排除项**:

- 不改变其他非编辑类工具的权限逻辑.
- 不改变代理现有 `tools` 工具白名单机制.
- 不新增新的权限系统或权限审批流程.

## 3. 配置规则

### 3.1 字段定义

- 字段名统一为 `editableFileSuffixes`.
- 类型为 `string[]`.
- 主代理和子代理都使用同名同类型字段.

### 3.2 配置含义

- `[]` 或未配置: 表示不限制可编辑后缀,默认允许编辑任意文件.
- `[".md"]`: 仅允许编辑 `.md` 文件.
- `[".md", ".java", ".py"]`: 仅允许编辑这三类后缀文件.

### 3.3 匹配与规范化规则

- 后缀匹配不区分大小写,比较前统一转为小写.
- 配置项在规范化前 MUST 先去掉前后空格.
- 配置项自动规范化:
  - `"md"` 视为 `".md"`.
  - 重复后缀去重后生效.
- 非法配置项处理:
  - 空字符串或仅空白字符串,忽略.
  - 单独 `"."`,忽略.
  - 规范化后为空的项,忽略.
- 若全部配置项都被忽略,等价于 `[]` 或未配置,即不限制.

### 3.4 后缀判定规则

- 后缀判定统一按文件名中最后一个 `.` 计算,并包含 `.`.
- 示例:
  - `a.test.ts` 的后缀为 `.ts`.
  - `.env` 的后缀为 `.env`.
  - `.config.json` 的后缀为 `.json`.
  - `a.` 视为无有效后缀.
- 无后缀文件处理:
  - 在有限制时,默认禁止编辑.
  - 在不限制时,允许编辑.

## 4. 编辑拦截与返回规则

### 4.1 生效前提

只有当代理本身具备对应编辑工具权限时,本配置才参与校验.

### 4.2 单文件编辑

- 若文件后缀允许,正常执行编辑.
- 若文件后缀不允许,不执行编辑,返回提示:
  - `你没有权限编辑 xxx 类型文件的权限,请注意你的任务权限范围`

### 4.3 批量编辑

- 若批量中既有允许文件,也有不允许文件:
  - 允许文件继续编辑.
  - 不允许文件跳过.
- 返回结果 MUST 按文件分别给出处理状态,至少包含:
  - 文件路径.
  - 是否执行编辑.
  - 若未执行,返回固定提示文案.
- 整体结果允许"部分成功",不得因单个文件被拒绝而回滚已成功文件.

### 4.4 提示中 xxx 的展示规则

- 常规文件: 展示实际后缀,例如 `.ts`.
- 点开头文件: 展示完整后缀,例如 `.env`.
- 无后缀文件: 展示文件名.

## 5. TUI 配置界面适配要求

- 主代理配置界面和子代理配置界面都新增 `editableFileSuffixes` 的编辑入口.
- 输入方式: 仅自定义输入,不提供预置后缀列表.
- 分隔规则: 支持英文逗号 `,` 和中文逗号 `，`.
- 清洗规则: 自动去掉每个后缀项前后空格.
- 保存规则:
  - 输入为空或全是空白时,保存为 `[]` 或未配置,表示不限制.
  - 输入后按第 3 章规则进行规范化与去重.
- 展示规则:
  - 界面显示应清晰提示 `[]` 或空值表示"不限制".
  - 编辑后回显内容应与实际生效配置一致.

## 6. 举例覆盖需求和边缘情况

- **例 1: 主代理限制 Markdown**

  - 配置: `[".md"]`
  - 编辑 `a.md`: 允许.
  - 编辑 `a.py`: 拒绝,提示中 `xxx` 为 `.py`.

- **例 2: 大小写兼容**

  - 配置: `[".md"]`
  - 编辑 `README.MD`: 允许.

- **例 3: 自动规范化配置**

  - 配置原始值: `["md", ".MD", ".md"]`
  - 生效等价于: `[".md"]`.

- **例 4: 点开头文件**

  - 配置: `[".env"]`
  - 编辑 `.env`: 允许.
  - 编辑 `.gitignore`: 拒绝,提示中 `xxx` 为 `.gitignore`.

- **例 5: 无后缀文件**

  - 配置: `[".md"]`
  - 编辑 `LICENSE`: 拒绝,提示中 `xxx` 为 `LICENSE`.

- **例 6: 多点文件名**

  - 配置: `[".ts"]`
  - 编辑 `a.test.ts`: 允许.

- **例 7: 文件名结尾为点**

  - 配置: `[".md"]`
  - 编辑 `a.`: 视为无后缀,拒绝.

- **例 8: 批量编辑混合结果**

  - 配置: `[".md", ".py"]`
  - 批量目标: `a.md`, `b.java`, `script.PY`
  - 结果: `a.md` 和 `script.PY` 执行编辑,`b.java` 跳过并提示.

- **例 9: TUI 输入兼容中文逗号**

  - 用户输入: `.md, .py，java`
  - 规范化后生效: `[".md", ".py", ".java"]`

- **例 10: TUI 输入为空**
  - 用户输入: `"   "`
  - 保存结果: `[]` 或未配置,表示不限制.

## 7. 验收标准

- 配置为 `[]` 或未配置时,编辑工具行为与当前完全兼容.
- 配置有限制时,仅允许后缀命中的文件被编辑.
- 仅 `filesystem-edit` 与 `filesystem-edit_search` 受该配置影响.
- 两个编辑工具都执行同一套后缀校验规则.
- 拒绝提示文案与需求一致,并正确替换 `xxx`.
- 批量编辑按"允许继续,不允许跳过并逐文件返回状态"执行.
- 大小写不敏感生效,如配置 `.md` 时,`README.MD` 允许编辑.
- 点开头文件按完整后缀匹配,如 `.env` 仅匹配 `.env`.
- 无后缀文件在有限制时禁止,在不限制时允许.
- 配置规范化生效,如 `["md", ".MD", ".md"]` 等价于 `[".md"]`.
- TUI 界面对该字段支持输入,保存,回显,并符合本需求规则. -->
已完成