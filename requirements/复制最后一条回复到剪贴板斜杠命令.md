# `/copy-last` 斜杠命令 - 复制最后一条 AI 回复到剪贴板

## 功能描述

新增 `/copy-last` 斜杠命令, 用于快速复制最后一条 AI 助手回复的内容到系统剪贴板。

## 实现文件

### 1. 命令注册

**文件**: `source/utils/commands/copyLast.ts`

```typescript
import {
	registerCommand,
	type CommandResult,
} from '../execution/commandExecutor.js';

// Copy last command handler - copies the last AI assistant message to clipboard
registerCommand('copy-last', {
	execute: (): CommandResult => {
		return {
			success: true,
			action: 'copyLastMessage',
		};
	},
});
```

### 2. 命令处理逻辑

**文件**: `source/hooks/conversation/useCommandHandler.ts` (行 924-986)

```typescript
} else if (result.success && result.action === 'copyLastMessage') {
	// Handle copy last message command - copy last AI assistant message to clipboard
	try {
		// Find the last assistant message
		const messages = options.messages;
		let lastAssistantMessage: Message | undefined;
		for (let i = messages.length - 1; i >= 0; i--) {
			const msg = messages[i];
			if (msg && msg.role === 'assistant' && !msg.subAgentInternal) {
				lastAssistantMessage = msg;
				break;
			}
		}

		if (!lastAssistantMessage) {
			const errorMessage: Message = {
				role: 'command',
				content: 'No AI assistant message found to copy.',
				commandName: commandName,
			};
			options.setMessages(prev => [...prev, errorMessage]);
			return;
		}

		// Get the content to copy
		const contentToCopy = lastAssistantMessage.content || '';

		if (!contentToCopy) {
			const errorMessage: Message = {
				role: 'command',
				content: 'The last AI assistant message has no content to copy.',
				commandName: commandName,
			};
			options.setMessages(prev => [...prev, errorMessage]);
			return;
		}

		// Copy to clipboard using platform-specific method
		await copyToClipboard(contentToCopy);

		// Show success message
		const messageLength = contentToCopy.length;
		const sizeDisplay =
			messageLength >= 1024
				? `${Math.floor(messageLength / 1024)}KB`
				: `${messageLength} characters`;

		const successMessage: Message = {
			role: 'command',
			content: `✓ Last AI message copied to clipboard (${sizeDisplay})`,
			commandName: commandName,
		};
		options.setMessages(prev => [...prev, successMessage]);
	} catch (error) {
		const errorMsg =
			error instanceof Error ? error.message : 'Unknown error';
		const errorMessage: Message = {
			role: 'command',
			content: `✗ Failed to copy to clipboard: ${errorMsg}`,
			commandName: commandName,
		};
		options.setMessages(prev => [...prev, errorMessage]);
	}
}
```

### 3. 剪贴板工具

**文件**: `source/utils/core/clipboard.ts`

- 使用 Base64 编码安全处理特殊字符（中文、引号、换行等）
- 支持 Windows (PowerShell)、macOS (pbcopy)、Linux (xclip/xsel)
- 详细的错误分类和处理

### 4. UI 集成

**文件**: `source/hooks/ui/useCommandPanel.ts` (行 15-20)

```typescript
{
	name: 'copy-last',
	description:
		t.commandPanel.commands.copyLast ||
		'Copy last AI message to clipboard',
},
```

### 5. 国际化支持

**中文**: `source/i18n/lang/zh.ts` (行 468)

```typescript
copyLast: '复制最后一条AI回复到剪贴板',
```

**繁中**: `source/i18n/lang/zh-tw.ts` (行 468)

```typescript
copyLast: '複製最後一條AI回覆到剪貼板',
```

**英文**: `source/i18n/lang/en.ts` (行 500)

```typescript
copyLast: 'Copy last AI message to clipboard',
```

## 使用方法

在聊天输入框中输入 `/copy-last` 并按 Enter 键。

## 行为说明

1. **查找消息**: 从消息列表倒序查找最后一条 `role='assistant'` 且不是 `subAgentInternal` 的消息
2. **验证内容**: 检查消息内容是否存在
3. **复制到剪贴板**: 使用跨平台方法复制内容
4. **显示反馈**:
   - 成功：显示内容大小（字符数或 KB）
   - 失败：显示具体错误信息

## 外部依赖

### Windows/macOS

- ✅ **无需额外安装** - 使用系统内置工具

### Linux

需要安装以下工具之一:

```bash
# 推荐: xclip
sudo apt-get install xclip    # Ubuntu/Debian
sudo yum install xclip        # CentOS/RHEL
sudo pacman -S xclip          # Arch Linux

# 备选: xsel
sudo apt-get install xsel     # Ubuntu/Debian
sudo yum install xsel         # CentOS/RHEL
sudo pacman -S xsel           # Arch Linux
```

程序会优先尝试 `xclip`, 如果不可用则回退到 `xsel`。

## 错误处理

- "No AI assistant message found to copy." - 没有找到 AI 助手消息
- "The last AI assistant message has no content to copy." - 最后一条消息没有内容
- "Clipboard tool not found: xclip/xsel is not available. Please install xclip/xsel." - Linux 下剪贴板工具未安装
- "Permission denied: Cannot access clipboard." - 权限被拒绝
- "Failed to copy to clipboard: ..." - 其他错误

## 技术特性

- ✅ 跨平台支持（Windows/macOS/Linux）
- ✅ Base64 编码处理特殊字符
- ✅ 详细的错误分类和提示
- ✅ 显示复制内容的大小反馈
- ✅ 过滤子代理内部消息（subAgentInternal）
- ✅ 无诊断错误
- ✅ 构建通过

## 验收标准

- [x] 代码构建通过
- [x] 无 TypeScript 诊断错误
- [x] 跨平台剪贴板工具实现
- [x] 国际化支持完整
- [x] 命令面板集成
- [x] 错误处理完善
- [ ] 实际测试（需要用户重启应用后测试）

-----

F:/Projects/snow-cli-upstream 创建个功能分支 也实现这个 斜杠命令.想提pr 给上游
因为我本地分支改了很多其他功能,不适合pr,故现在需要根据我自用分支的实现和本需求文档 在 F:/Projects/snow-cli-upstream 新开一个功能分支 手动编写一份适合给上游提pr的版本
并且pr通过后 我会 在将上游合并到 我本地分支,故两个实现偏差不能太大,便于我后续合并
别直接用命令检出修改过去,对比着手动改
---
已提pr