# éœ€æ±‚æ–‡æ¡£: æµå¼ API ç©ºé—²è¶…æ—¶é‡è¯•æœºåˆ¶

## 1. é¡¹ç›®ç°çŠ¶ä¸æ ¸å¿ƒç›®æ ‡

### ç°çŠ¶

å½“å‰é¡¹ç›®ä¸­,æµå¼ API å“åº”(`createStreamingAnthropicCompletion`, `createStreamingGeminiCompletion` ç­‰)ä»…åœ¨è¿æ¥æ–­å¼€æ—¶æ‰ä¼šè§¦å‘é‡è¯•æœºåˆ¶(`withRetryGenerator`)ã€‚

**é—®é¢˜åœºæ™¯**:

- API è¿æ¥ä¿æŒæ‰“å¼€çŠ¶æ€(æœªæ–­å¼€)
- ä½†é•¿æ—¶é—´(å¦‚å‡ åˆ†é’Ÿ)æ²¡æœ‰æ”¶åˆ°æ–°çš„æ•°æ®å—(chunk)
- ç”¨æˆ·ç•Œé¢æ˜¾ç¤º"æ­£åœ¨ç”Ÿæˆ..."ä½†æ²¡æœ‰ä»»ä½•è¿›å±•
- æ²¡æœ‰æœºåˆ¶æ¥æ£€æµ‹è¿™ç§"å‡æ­»"çŠ¶æ€

### æ ¸å¿ƒç›®æ ‡

ä¸ºæµå¼ API å“åº”æ·»åŠ **ç©ºé—²è¶…æ—¶æ£€æµ‹æœºåˆ¶**:å¦‚æœåœ¨æŒ‡å®šæ—¶é—´å†…(é»˜è®¤ 3 åˆ†é’Ÿ)æ²¡æœ‰æ”¶åˆ°æ–°çš„æ•°æ®,åˆ™è§†ä¸ºè¶…æ—¶,è§¦å‘æ–­å¼€é‡è¿å¹¶é‡è¯•ã€‚

## 2. èŒƒå›´ä¸è¾¹ç•Œ

### åŠŸèƒ½ç‚¹

- [ ] **ç©ºé—²è¶…æ—¶æ£€æµ‹**: åœ¨æµå¼è¯»å–è¿‡ç¨‹ä¸­,ç›‘æ§æœ€åä¸€æ¬¡æ”¶åˆ°**ä»»ä½•æ•°æ®**(åŒ…æ‹¬æ€è€ƒå†…å®¹å’Œæ­£å¼å›å¤)çš„æ—¶é—´
- [ ] **ç©ºé—²è¶…æ—¶å¸¸é‡**: è¶…æ—¶æ—¶é—´å›ºå®šä¸º 3 åˆ†é’Ÿ(180000ms),ä»¥å¸¸é‡å½¢å¼å­˜å‚¨åœ¨ä»£ç ä¸­
- [ ] **è¶…æ—¶åé‡è¯•**: è§¦å‘ `withRetryGenerator` çš„é‡è¯•é€»è¾‘
- [ ] **é€‚ç”¨ API**: Anthropicã€Geminiã€Chatã€Responses ç­‰æ‰€æœ‰æµå¼ API

### æ’é™¤é¡¹

- ä¸ä¿®æ”¹éæµå¼ API çš„è°ƒç”¨
- ä¸æ”¹å˜ç°æœ‰çš„è¿æ¥è¶…æ—¶é€»è¾‘(åªæ·»åŠ ç©ºé—²è¶…æ—¶)
- è¶…æ—¶æ—¶é—´ä¸å¯é…ç½®(å›ºå®š 3 åˆ†é’Ÿ)
- ä¸å½±å“å·²æ­£å¸¸å·¥ä½œçš„æµå¼ä¼ è¾“

## 3. ä¸¾ä¾‹è¦†ç›–éœ€æ±‚å’Œè¾¹ç¼˜æƒ…å†µ

### ä¾‹ 1: æ­£å¸¸æµå¼ä¼ è¾“

```
æ—¶é—´çº¿:
0s      30s     60s     90s     120s    (å®Œæˆ)
|-------|-------|-------|-------|-------->
[chunk1][chunk2][chunk3][chunk4][DONE]

ç»“æœ: æ­£å¸¸å®Œæˆ,æ— è¶…æ—¶è§¦å‘
```

### ä¾‹ 2: ç©ºé—²è¶…æ—¶è§¦å‘é‡è¯•

```
æ—¶é—´çº¿:
0s      30s     60s     ...     180s(3åˆ†é’Ÿ)
|-------|-------|-------|-------|-------->
[chunk1][chunk2]        (æ— æ•°æ®)  -> è§¦å‘è¶…æ—¶é‡è¯•

ç»“æœ:
1. æ£€æµ‹åˆ° 3 åˆ†é’Ÿæ— æ–°æ•°æ®
2. æŠ›å‡ºå¯é‡è¯•é”™è¯¯
3. withRetryGenerator æ•è·é”™è¯¯
4. å»¶è¿Ÿåé‡è¯•è¯·æ±‚
```

### ä¾‹ 3: éƒ¨åˆ†æ•°æ®åç©ºé—²è¶…æ—¶

```
æ—¶é—´çº¿:
0s      30s     60s     90s     ...     270s(4.5åˆ†é’Ÿ)
|-------|-------|-------|-------|-------|-------->
[chunk1][chunk2][chunk3]        (æ— æ•°æ® 3åˆ†é’Ÿ) -> è¶…æ—¶é‡è¯•

æ³¨æ„: å³ä½¿å·²ç»äº§ç”Ÿè¿‡æ•°æ®(hasYielded=true),ç©ºé—²è¶…æ—¶ä¹Ÿåº”è¯¥è§¦å‘é‡è¯•
(ä¸ç°æœ‰é€»è¾‘ä¸åŒ,ç°æœ‰é€»è¾‘æ˜¯ hasYielded=true æ—¶éæµä¸­æ–­é”™è¯¯ä¸é‡è¯•)
```

### ä¾‹ 4: é‡è¯•åæˆåŠŸ

```
ç¬¬ 1 æ¬¡è¯·æ±‚:
0s      60s     180s(è¶…æ—¶)
|-------|-------|-------->
[data]  (æ— å“åº”) -> è¶…æ—¶æ–­å¼€

ç­‰å¾… 1s (æŒ‡æ•°é€€é¿)

ç¬¬ 2 æ¬¡è¯·æ±‚:
0s      30s     60s
|-------|-------|-------->
[data1][data2][DONE]

ç»“æœ: é‡è¯•æˆåŠŸ,è¿”å›å®Œæ•´æ•°æ®
```

### è¾¹ç¼˜æƒ…å†µ

#### è¾¹ç¼˜ 1: æ°å¥½ 3 åˆ†é’Ÿæ”¶åˆ°æ•°æ®

```
0s      179s    180s
|-------|-------|-------->
[data1]         [data2]  <-- æ°å¥½åœ¨è¶…æ—¶å‰æ”¶åˆ°

ç»“æœ: ä¸åº”è§¦å‘è¶…æ—¶,ç»§ç»­ç­‰å¾…
```

#### è¾¹ç¼˜ 2: ç”¨æˆ·ä¸»åŠ¨ä¸­æ–­

```
ç”¨æˆ·æŒ‰ ESC / ç‚¹å‡»åœæ­¢

ç»“æœ:
- åº”å°Šé‡ abortSignal
- ä¸è§¦å‘è¶…æ—¶é‡è¯•
- ç«‹å³ç»ˆæ­¢
```

### è¾¹ç¼˜ 3: æœåŠ¡ç«¯é•¿æ—¶é—´æ€è€ƒ(thinking)

```
æŸäº›æ¨¡å‹(å¦‚ Claude with thinking)å¯èƒ½ä¼šæœ‰é•¿æ—¶é—´æ€è€ƒé˜¶æ®µ

0s      60s     120s    180s    240s
|-------|-------|-------|-------|-------->
[start thinking]        [end thinking][output]
   â†‘                       â†‘
æŒç»­æ”¶åˆ° thinking æ•°æ®    æ”¶åˆ°æ­£å¼å›å¤

ç»“æœ:
- **æ€è€ƒå†…å®¹(thinking content)ä¹Ÿç®—ä½œæ–°å¢æ•°æ®**
- åªè¦æŒç»­æ”¶åˆ°ä»»ä½•æ•°æ®(åŒ…æ‹¬ thinking),å°±ä¸è§¦å‘ç©ºé—²è¶…æ—¶
- åªæœ‰åœ¨å®Œå…¨æ²¡æœ‰æ•°æ®è¿”å›(åŒ…æ‹¬ thinking)è¾¾ 3 åˆ†é’Ÿæ—¶æ‰è¶…æ—¶
```

## 4. æŠ€æœ¯è¦ç‚¹

### å®ç°ä½ç½®

- ä¿®æ”¹ `source/utils/core/retryUtils.ts` ä¸­çš„ `withRetryGenerator`
- æˆ–åœ¨å„ API æµå¼è¯»å–é€»è¾‘ä¸­æ·»åŠ ç©ºé—²æ£€æµ‹

### å…³é”®é€»è¾‘

```typescript
// ä¼ªä»£ç 
const STREAM_IDLE_TIMEOUT = 180000; // 3åˆ†é’Ÿ,ä»£ç ä¸­å›ºå®š
let lastChunkTime = Date.now();

// å¯åŠ¨ç©ºé—²æ£€æµ‹å®šæ—¶å™¨
const idleTimer = setInterval(() => {
	if (Date.now() - lastChunkTime > idleTimeout) {
		throw new StreamIdleTimeoutError(`No data received for ${idleTimeout}ms`);
	}
}, 5000); // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡

// æ”¶åˆ°æ•°æ®æ—¶æ›´æ–°
for await (const chunk of stream) {
	lastChunkTime = Date.now();
	yield chunk;
}

clearInterval(idleTimer);
```

### é”™è¯¯ç±»å‹

éœ€è¦å®šä¹‰æ–°çš„é”™è¯¯ç±»å‹ `StreamIdleTimeoutError`,æ ‡è®°ä¸ºå¯é‡è¯•é”™è¯¯ã€‚

## 5. å¸¸é‡å®šä¹‰

```typescript
// source/utils/core/retryUtils.ts æˆ–ç›¸å…³å¸¸é‡æ–‡ä»¶
export const STREAM_IDLE_TIMEOUT = 180000; // 3åˆ†é’Ÿ
```

## 6. ç”¨æˆ·å¯è§è¡Œä¸º

### è¶…æ—¶é‡è¯•æ—¶

```
ğŸ”„ æµå¼å“åº”ç©ºé—²è¶…æ—¶,æ­£åœ¨é‡è¯• (1/5): 3åˆ†é’Ÿæœªæ”¶åˆ°æ•°æ®,é‡æ–°è¿æ¥ä¸­...
```

### æœ€ç»ˆå¤±è´¥æ—¶

```
âŒ æµå¼å“åº”å¤±è´¥: å·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°,APIæŒç»­æ— å“åº”
```
