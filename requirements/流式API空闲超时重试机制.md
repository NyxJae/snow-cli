# 需求文档: 流式 API 空闲超时重试机制

## 1. 项目现状与核心目标

### 现状

当前流式 API 在连接断开时可触发重试,但对"连接未断开,长时间无新增数据"的假死场景缺少统一治理。

### 核心目标

新增"长时无返回超时"能力,并允许在 `API和模型设置` 中配置。
当流式响应在指定秒数内未收到任何新增数据时,判定为 idle timeout,触发断开重连与重试。

默认值与单位规则:

- 默认值: `180s`.
- 配置单位: `s`(秒).
- 字段名: `streamIdleTimeoutSec`.

## 2. 范围与边界

### 功能点

- [ ] 空闲超时检测: 流式读取过程中监控最后一次收到任何数据的时间.
- [ ] 数据口径统一: thinking/reasoning/content/tool-call 等都算"收到新数据".
- [ ] 可配置超时: 在 `API和模型设置` 提供 `streamIdleTimeoutSec` 配置项,默认 `180`.
- [ ] 配置文件适配: `C:/Users/Administrator/.snow/profiles` 下 profile 配置文件必须读写 `snowcfg.streamIdleTimeoutSec`.
- [ ] 非法值回退: 非法配置值回退默认 `180s`.
- [ ] 超时后重试: 复用 `withRetryGenerator` 重试机制.
- [ ] 断开后消息丢弃: 任意断开后旧连接迟到消息必须丢弃,不得继续输出.
- [ ] 适用范围: Anthropic, Gemini, Chat, Responses 四类流式 API 行为保持一致.

### 排除项

- 不修改非流式 API 调用路径.
- 不调整现有连接超时机制,仅新增"长时无返回超时".
- 不新增断点续传语义,超时后仍为"整次请求重发".
- 不要求本需求引入多层优先级,仅使用一个超时配置字段.

## 3. 配置规则

### 3.1 配置入口

- UI 入口: `API和模型设置`.
- 配置字段: `streamIdleTimeoutSec`.
- 展示文案建议: "长时无返回超时时长(秒)".

### 3.2 数据与默认

- 字段类型: 整数秒.
- 默认值: `180`.
- 运行时换算: `streamIdleTimeoutSec * 1000`.

### 3.3 非法值处理

无配置(字段缺失)视为使用默认值,不视为错误.

以下输入视为非法值:

- 非数字.
- 非整数.
- 空字符串.

处理规则:

- 统一回退默认值 `180s`.
- 不中断请求流程.

### 3.4 profiles 适配

- `C:/Users/Administrator/.snow/profiles` 下的 profile 配置文件必须支持并保存 `snowcfg.streamIdleTimeoutSec`.
- 切换 profile 时,该字段应随 profile 一起切换.
- profile 未配置或字段非法时,按默认 `180s` 生效.

## 4. 运行行为规则

### 4.1 超时判定

- 从流开始读取起计时.
- 每收到一条有效业务数据就刷新"最后活跃时间".
- 心跳或空事件不刷新计时器.
- 连续超过 `streamIdleTimeoutSec` 秒无新数据即判定超时.

### 4.2 超时后动作

- 标记当前流为 abandoned.
- 取消旧 reader.
- 抛出可重试错误进入重试链路.
- 按现有指数退避继续重试.

### 4.3 断开后消息丢弃

- 旧连接在断开后收到的延迟 chunk 必须丢弃.
- 旧连接数据不得与新连接重试数据混合输出.

### 4.4 用户主动中断

- 用户主动停止时应立即终止.
- 不触发超时重试.

## 5. 举例覆盖需求与边缘情况

### 例 1: 正常流式传输(默认 180s)

输入场景:

- 配置 `streamIdleTimeoutSec = 180`.
- 每 20~40 秒都有新 chunk.

预期结果:

- 不触发超时.
- 正常结束.

### 例 2: 长时无返回触发重试

输入场景:

- 配置 `streamIdleTimeoutSec = 180`.
- 前 60 秒有数据,后续 180 秒无任何新增数据.

预期结果:

1. 判定 idle timeout.
2. 标记旧流 abandoned 并取消 reader.
3. 进入重试链路.

### 例 3: 配置改为 60s 后更快触发

输入场景:

- 配置 `streamIdleTimeoutSec = 60`.
- 70 秒无新增数据.

预期结果:

- 在约 60 秒阈值附近触发超时重试,而不是等待 180 秒.

### 例 4: 非法配置自动回退默认

输入场景:

- `streamIdleTimeoutSec = "abc"` 或 `12.5` 或空值.

预期结果:

- 自动按 `180s` 生效.
- 不因配置错误导致崩溃.

### 例 5: thinking 持续输出不算超时

输入场景:

- 模型长时间思考,持续返回 thinking/reasoning 数据.

预期结果:

- 只要有任意新增数据就刷新活跃时间.
- 不触发超时.

### 例 6: 超时后旧连接迟到消息

输入场景:

- 第 1 次请求已超时并进入第 2 次重试.
- 第 1 次旧连接随后返回迟到 chunk.

预期结果:

- 迟到 chunk 被丢弃.
- 仅展示第 2 次连接数据.

### 例 7: 用户主动停止

输入场景:

- 用户在流式生成中按 ESC 或点击停止.

预期结果:

- 立即终止.
- 不进入重试.

## 6. 用户可见行为

### 超时重试提示

```text
🔄 流式响应空闲超时,正在重试(当前第 X 次): 已连续 N 秒未收到有效数据,重新连接中...
```

注: X 由现有重试机制决定,本需求不新增重试次数配置.

### 达到最大重试提示

```text
❌ 流式响应失败: 已达到最大重试次数,API 持续无响应.
```

## 7. 验收清单

- [ ] `API和模型设置` 可编辑 `streamIdleTimeoutSec`.
- [ ] `profiles` 配置文件可读写 `snowcfg.streamIdleTimeoutSec`.
- [ ] 字段非法时回退 `180s`.
- [ ] 四类流式 API 行为一致.
- [ ] 断开后迟到消息被丢弃.
- [ ] 用户主动停止不重试.
- [ ] 文档口径中不再出现"固定不可配置"表述.
