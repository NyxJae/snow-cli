# 需求文档

## 1. 项目现状与核心目标

- 现状: 现在 Agent 调用工具记录的笔记会写入工作项目的 `.snow/notebook/<项目名>.json` 单文件中,笔记数组是按时间插入顺序(最新在前)管理.
- 目标: 在保持单文件 json 和扁平 key(路径字符串)不变的前提下,将整个 json 的 key 写入顺序调整为“按文件路径的树形顺序”,便于人工查看和对齐文件树结构.

## 2. 范围与边界

**功能点简述**:

- [x] 持久化写入时,对所有路径 key 做全局树形排序,保证父路径在前,子路径在后.
- [x] 同级路径排序规则: 先文件夹后文件,再按字典序升序(字母/数字).
- [x] 字典序采用 ASCII/Unicode 顺序,区分大小写与特殊字符(如 `A` 在 `a` 之前, `-` 在 `_` 之前).
- [x] 仍使用扁平 key 结构,不改为嵌套对象或树节点数组.
- [x] 单条路径下的笔记数组顺序保持现状(最新在前),不因路径排序而改变.
- [x] 既有笔记 json 需要按新规则重新排序后写回,对用户无感.
- [x] 触发时机: 每次新增或更新笔记后,都需要重排并写回.

**实现状态备注** (2026-02-06):

- ✅ 已实现: 树形排序 - notebookManager.ts:130-169 compareNotebookPaths() 实现父路径优先,同级文件夹优先,字典序
- ✅ 已实现: 排序应用 - notebookManager.ts:174-183 sortNotebookDataByPath() + 188-198 saveNotebookData() 写回前调用排序
- ✅ 已实现: 清理空数组 - notebookManager.ts:176 过滤空数组 `.filter(([, entries]) => entries.length > 0)`

**排除项**:

- 不将单文件 json 拆分为多文件或多目录存储.
- 不新增 UI 树形浏览或交互能力.
- 不引入嵌套 json 结构.

## 3. 举例覆盖需求和边缘情况

- **例 1: 基本树形顺序**

  - 输入 key 列表(顺序杂乱):
    - `aaa/ccc/ddd.ts`
    - `aaa/`
    - `aaa/eee/`
    - `aaa/bbb.ts`
    - `aaa/ccc/`
  - 期望写入顺序:
    1. `aaa/`
    2. `aaa/ccc/`
    3. `aaa/ccc/ddd.ts`
    4. `aaa/eee/`
    5. `aaa/bbb.ts`

- **例 2: 同级文件夹优先**

  - 输入:
    - `src/a.ts`
    - `src/z/`
    - `src/b/`
  - 期望写入顺序:
    1. `src/b/`
    2. `src/z/`
    3. `src/a.ts`

- **例 3: 仅单一路径**

  - 输入: `docs/readme.md`
  - 期望: 顺序不变,仅保证仍是扁平 key.

- **例 4: 同级字典序**

  - 输入:
    - `src/10/`
    - `src/2/`
    - `src/a/`
  - 期望写入顺序(按字典序):
    1. `src/10/`
    2. `src/2/`
    3. `src/a/`

- **例 5: 大小写与特殊字符(ASCII/Unicode 顺序)**

  - 输入:
    - `src/A/`
    - `src/a/`
    - `src/-temp/`
    - `src/_temp/`
  - 期望写入顺序:
    1. `src/-temp/`
    2. `src/_temp/`
    3. `src/A/`
    4. `src/a/`

- **例 6: 根目录与空路径**

  - 输入:
    - `/`
    - `src/`
    - `src/a.ts`
  - 期望写入顺序:
    1. `/`
    2. `src/`
    3. `src/a.ts`
  - 说明: 空路径不作为合法 key,仅根目录 `/` 可作为文件夹路径.

- **例 7: 同名文件与文件夹冲突**
  - 输入:
    - `docs`
    - `docs/`
    - `docs/readme.md`
  - 期望写入顺序:
    1. `docs/`
    2. `docs/readme.md`
    3. `docs`
  - 说明: 通过 `/` 结尾区分文件夹与文件,文件夹优先.

# 笔记清理

"show-windows-toast.js": []
这样的 空笔记 ,排序啊读取或者写回时,发现了就顺便清理了,找个合适的逻辑时机
