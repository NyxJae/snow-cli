{
  "5d44de8a-d5e6-47a9-a451-3020c474883a:2": [
    {
      "op": "add",
      "notebookId": "notebook-1771478149195_7bs0m83xf"
    },
    {
      "op": "add",
      "notebookId": "notebook-1771478149329_cgfw81aim"
    },
    {
      "op": "add",
      "notebookId": "notebook-1771478149452_7h0fhq8s9"
    },
    {
      "op": "add",
      "notebookId": "notebook-1771478149573_hpypjn8r8"
    },
    {
      "op": "add",
      "notebookId": "notebook-1771478149697_iovnxgo37"
    },
    {
      "op": "add",
      "notebookId": "notebook-1771478236512_49avnxm82"
    },
    {
      "op": "add",
      "notebookId": "notebook-1771478236626_h1uenh7uo"
    }
  ],
  "ba796024-2865-440a-8322-f2be8bfe7e7e:138": [
    {
      "op": "update",
      "notebookId": "notebook-1770979050662_42h7p1qh5",
      "previousNote": "职责: SSE 服务端协议边界与连接管理.负责维护 SSEEventType/ClientMessage 等协议类型,建立 HTTP SSE 连接,并维护 connectionId <-> sessionId 的单对单绑定,把客户端消息分发给上层 messageHandler(通常为 SSEManager).\n不该做什么:\n- 不在本层实现主代理选择/切换逻辑,仅承载协议字段并把消息交给 SSEManager.\n- 不在本层持久化任何会话业务状态(如 currentMainAgentId/currentSessionAgentId),避免与 sessionManager/sseManager 职责重叠.\n接口摘要(协议层):\n- SSEEventType: 事件类型联合.新增扩展: agent_list,agent_switched.其他事件包括 connected,message,tool_call/tool_result,tool_confirmation_request,user_question_request,rollback_request 等.\n- ClientMessage: 客户端消息结构.新增扩展: type='switch_agent' + agentId 字段.其他消息包括 chat,image,tool_confirmation_response,user_question_response,abort,rollback.\n- AgentInfo: { id: string; name: string; description: string },用于 agent_list/error.availableAgents 下发(仅展示/选择,不包含敏感配置).\n接口摘要(连接与错误):\n- 建链成功后发送 connected 事件,其后由 SSEManager 决定是否立即推送 agent_list.\n- sessionId 绑定失败时返回 400,不再 fallback 到任意已有连接(避免跨 session 串扰与错误路由).\n- 连接断开时必须清理连接相关资源,包含 sessionConnections,避免 sessionId 残留指向无效 connectionId.\n依赖拓扑:\n- 上游: source/utils/sse/sseManager.ts 作为 messageHandler 调用方,并承载会话级主代理状态.\n- 下游: Node http createServer/IncomingMessage/ServerResponse.\n避坑指南:\n- 协议扩展必须向后兼容: 老客户端遇到未知 event.type 应静默忽略,因此新增事件不要复用旧类型语义.\n- sendEvent 的 data 字段只传业务必要字段,避免把完整 MainAgentConfig 或工具权限细节泄漏到客户端.\n- 单对单映射是核心约束: 不再支持\"同一 sessionId 多连接复用\".如果未来重启该方向,需要整体升级映射模型为 sessionId -> Set<connectionId>,并同步重做断线清理,并发一致性与广播策略评估."
    },
    {
      "op": "update",
      "notebookId": "notebook-1771478236626_h1uenh7uo",
      "previousNote": "职责: SSE 会话级业务管理器.负责: 维护 sessionId 与 connectionId 的绑定关系,分发客户端消息(chat,image,abort,rollback,switch_agent 等)到对话执行层,并把执行层输出封装为 SSEEvent 推送给对应连接.\\n主代理能力(已实现,客户端需对接):\\n- 连接绑定 session 后,可下发 agent_list({agents,currentAgentId}).\\n- 处理 switch_agent: 校验 agentId 格式与可用性,校验 session busy 状态,成功后更新 session->agentId 映射并推送 agent_switched({previousAgentId,currentAgentId,agentName}).\\n- 失败时推送 error,包含主代理相关 errorCode: invalid_agent_id,invalid_agent_id_format,agent_not_found(带 availableAgents),agent_busy,session_not_found.\\n接口摘要:\\n- 输入: ClientMessage(来自 source/api/sse-server.ts),包含 sessionId 可选字段;以及会话管理器(sessionManager)与主代理管理器(mainAgentManager).\\n- 输出: SSEEvent,包含 connected,message,agent_list,agent_switched,error 等.\\n依赖拓扑:\\n- 上游: source/api/sse-server.ts 负责协议层与 HTTP SSE 连接.\\n- 下游: sessionManager(会话持久化/状态),mainAgentManager(主代理配置与可用列表),对话执行器(产出 message/complete/tool_* 事件).\\n避坑指南:\\n- 主代理切换以 sessionId 为边界,不得以 connectionId 推断跨会话状态.\\n- agent_list 应在绑定/重绑定 session 后推送,客户端重连后必须等待该事件再启用选择器,避免使用过期 agents.\\n- error.availableAgents 仅用于展示/回填,不得泄漏完整代理配置(含工具权限/提示词等)."
    },
    {
      "op": "update",
      "notebookId": "notebook-1771478149329_cgfw81aim",
      "previousNote": "职责: SSE 客户端示例的主逻辑.负责连接管理(EventSource),统一事件分发(handleEvent),消息发送(chat,abort,rollback,tool/user_question 响应),会话列表与当前会话状态维护,以及聊天 UI 渲染.\\n接口摘要: \\n- connect()/disconnect(): 建立/关闭 SSE,维护在线状态.\\n- handleEvent(event): 按 event.type 分派到各处理分支,并更新 UI.\\n- sendMessage()/sendResponse()/...: 通过 fetch 发送客户端消息.\\n主代理扩展(本需求): \\n- 维护状态: agents: AgentInfo[], currentAgentId: string|null, isSwitching: boolean, pendingAgentId/previousAgentId(用于回滚).\\n- 处理事件: agent_list(刷新下拉,同步 currentAgentId), agent_switched(更新 currentAgentId,提示系统消息,结束 switching).\\n- 发送消息: switch_agent({agentId,sessionId}) 并在 UI 上表现 loading/回滚.\\n断线重连: \\n- onerror/close 时必须 reset agents/currentAgentId/isSwitching 并禁用选择器显示(未连接).\\n避坑指南: \\n- UI 事件(change)触发 switch_agent 时要做去抖/锁: isSwitching=true 时忽略重复切换.\\n- agent_switched 是服务端确认,客户端不得仅凭 change 事件就更新 currentAgentId(必须等确认或 error 回滚).\\n- error 事件需区分通用错误与主代理切换错误码(invalid_agent_id/_format,agent_not_found,agent_busy,session_not_found),并提供明确提示;对 agent_not_found 可利用 availableAgents 刷新/回填下拉."
    },
    {
      "op": "add",
      "notebookId": "notebook-1771494873344_kvcdeq9mx"
    },
    {
      "op": "update",
      "notebookId": "notebook-1770979050800_ws9seqhn5",
      "previousNote": "职责: SSE 服务编排与会话交互管理.负责启动/停止 SSEServer,处理 ClientMessage(chat,image,abort,rollback,交互响应等),并与 sessionManager/useConversation 对接实现会话级对话.\n核心架构决策(会话隔离,关键约束):\n- 一个 sessionId 只对应一个 SSE 连接(不支持同 session 多连接复用).\n- 因此任何\"会话级\"状态都必须以 sessionId 为 key,且只影响该 sessionId 当前绑定的单个 connectionId.\n关键状态(本需求新增/修复):\n- sessionAgentIds: Map<string,string>,sessionId -> agentId.作为会话级主代理选择的唯一事实源,默认 defaultAgentId='general'.\n- connectionSessionMap: Map<string,string>,connectionId -> sessionId.用于替代穿透读取 (this.server as any).sessionConnections,并在断连时完成会话绑定清理.\n- pendingInteractions: 等待 tool_confirmation/user_question 的交互队列.本次修复要求 PendingInteraction 增加 sessionId 字段,busy 判定必须精确匹配 sessionId.\n本模块职责(与主代理选择相关):\n- 在 connected 后立即推送 agent_list(availableAgents),为客户端提供可选项.\n- 处理 switch_agent 客户端消息,完成会话级 agentId 切换并推送 agent_switched,或返回错误事件.\n- 统一错误事件结构,均附带 availableAgents,便于客户端恢复与重新选择.\n不该做什么:\n- 不在此处解析/加载 main-agents.toml 细节,通过 MainAgentManager 提供的查询接口获取可用代理列表与配置.\n- 不把主代理状态存成全局单例字段导致跨 session 串扰.\n接口摘要(与切换相关):\n- handleSwitchAgentRequest({ agentId },{ connectionId,sendEvent }):\n  - 先通过 connectionSessionMap 获取 sessionId,不存在则 errorCode=session_not_found.\n  - 校验 agentId: 空 -> invalid_agent_id;格式不匹配 ^[a-z0-9_-]+$ -> invalid_agent_id_format;不在 listAvailableAgents -> agent_not_found.\n  - busy 判定: 若该 sessionId 存在进行中的对话(sessionControllers)或该 sessionId 有 pendingInteractions,则 errorCode=agent_busy.\n  - 通过 MainAgentManager.getAgentConfig(agentId) 做最终存在性校验,并更新 sessionAgentIds.set(sessionId,agentId).\n  - 推送 agent_switched({ sessionId,agent:{id,name,description} }).\n错误码体系(固定枚举,客户端可依赖):\n- invalid_agent_id,invalid_agent_id_format,agent_not_found,agent_busy,session_not_found.\n依赖拓扑:\n- 依赖: source/api/sse-server.ts(协议与连接),source/utils/session/sessionManager.ts(会话创建/续接),source/utils/MainAgentManager.ts(可用代理列表与配置查询).\n- 被依赖: 启动入口(命令/服务模式)调用 start/stop,以及 SSEServer 回调.\n避坑指南:\n- busy 判定必须覆盖所有进行中的任务: 对话生成流(sessionControllers) + pendingInteractions(等待 tool_confirmation/user_question).\n- session 绑定验证: 任何需要 sessionId 的操作必须通过 connectionSessionMap 校验连接已绑定,防止\"幽灵 session\"(客户端伪造 sessionId 或断线残留).\n- 切换只影响后续新对话: 进行中的对话继续使用旧 agent 配置;若要立即生效,客户端应先 abort.\n- 错误事件统一附带 availableAgents,否则客户端无法在无 UI 的场景做自恢复.\n- agent_list/agent_switched 是协议扩展,必须允许老客户端忽略未知事件类型(向后兼容)."
    },
    {
      "op": "delete",
      "entry": {
        "id": "notebook-1771478236626_h1uenh7uo",
        "filePath": "source/utils/sse/sseManager.ts",
        "note": "职责: SSE 会话级业务管理器.负责维护 sessionId <-> connectionId 的绑定镜像,分发客户端消息(chat,image,abort,rollback,switch_agent 等)到对话执行层,并把执行层输出封装为 SSEEvent 推送回对应连接.\n\n关键结论(会话绑定时序修复):\n- SSEServer 在 /session/create,/session/load 绑定会话后触发 sessionBoundHandler.\n- SSEManager.start() 必须注册 server.setSessionBoundHandler,调用自身 bindSessionToConnection 同步 connectionSessionMap,从而在严格校验 switch_agent 时避免 session_not_found 误判.\n\n接口摘要:\n- 输入: SSEServer 回调(messageHandler,connectionCreatedHandler,sessionCreatedHandler,sessionBoundHandler 等)与 sessionManager/mainAgentManager.\n- 输出: SSEEvent(connected,message,agent_list,agent_switched,error 等).\n\n依赖拓扑:\n- 上游: source/api/sse-server.ts(协议与连接).\n- 下游: source/utils/session/sessionManager.ts,source/utils/MainAgentManager.ts,对话执行器(useConversation/toolExecutor 等).\n\n避坑指南:\n- 会话隔离: 所有主代理状态与 busy 判定必须以 sessionId 为 key,禁止用 connectionId 推断跨会话状态.\n- 映射一致性: connectionSessionMap 是业务层的镜像,来源于 SSEServer 的绑定事实.不要从 (server as any).sessionConnections 穿透读取.\n- 回调职责: sessionBoundHandler 只负责同步映射,不要在回调里做额外 bind 或广播,避免重复触发与竞态.\n- 错误恢复: error.availableAgents 仅用于展示/回填,不得泄漏完整代理配置(提示词,工具权限等).",
        "createdAt": "2026-02-19T13:17:16.625",
        "updatedAt": "2026-02-19T17:54:33.032"
      }
    },
    {
      "op": "add",
      "notebookId": "notebook-1771495044055_cbcvm3sjp"
    },
    {
      "op": "add",
      "notebookId": "notebook-1771495044206_arra3wr1q"
    },
    {
      "op": "add",
      "notebookId": "notebook-1771495044343_9q2dkp8qw"
    },
    {
      "op": "update",
      "notebookId": "notebook-1771478149195_7bs0m83xf",
      "previousNote": "职责: 浏览器端 SSE 客户端示例(开发/联调用途),用于验证 Snow CLI 的 SSE 服务协议(connected,message,agent_list,agent_switched,error 等)与会话管理 API.\\n不该做什么: \\n- 不作为生产级前端架构,不引入复杂框架/构建工具.\\n- 不实现服务端业务逻辑,仅消费协议并展示.\\n接口摘要: \\n- 输入: EventSource(/events) 事件流 + fetch(/message,/session/*,/response) 等 HTTP 调用.\\n- 输出: DOM UI(聊天消息,状态,会话列表,主代理选择器) + 控制台/事件日志.\\n依赖拓扑: \\n- 依赖: source/api/sse-server.ts 的协议契约与 source/utils/sse/sseManager.ts 的事件/错误码实现,以及 docs/usage/zh/20.SSE服务模式.md 文档.\\n- 被依赖: 无(仅示例).\\n避坑指南: \\n- 必须对未知 event.type 做容错,避免服务端新增事件导致客户端崩溃.\\n- 断线重连时必须清理 UI 状态(禁用输入/选择器,清空 agents/currentAgentId/isSwitching),重连后等待 agent_list 再启用选择器,避免使用过期列表切换.\\n- 切换主代理必须以 sessionId 为边界,客户端已知 currentSessionId 时必须随 switch_agent 一并发送,避免依赖连接绑定产生歧义."
    }
  ],
  "8b0f5855-a011-4562-8149-82eccb7a5d89:315": [
    {
      "op": "update",
      "notebookId": "notebook-1771495044343_9q2dkp8qw",
      "previousNote": "职责: 需求与变更记录目录.存放功能需求、协议约束与验收标准,作为实现与回归测试的参考依据.\n\n接口摘要:\n- 输入: 产品/开发需求.\n- 输出: 可执行的实现约束(协议结构,UI 行为,错误码文案),指导 source/test/sse-client/ 示例与服务端协议演进.\n\n依赖拓扑:\n- 被依赖: 客户端示例实现(source/test/sse-client/*),以及服务端协议扩展评审.\n\n避坑指南:\n- 需求文档应成为 SSoT: 协议字段与错误码变更需同步更新对应文档,避免实现与文档漂移.\n- 标注兼容性要求: 明确 unknown event.type 静默忽略,以及 currentAgentId 可为 null 的语义."
    },
    {
      "op": "add",
      "notebookId": "notebook-1771515649312_x6aph0c29"
    },
    {
      "op": "add",
      "notebookId": "notebook-1771515825742_q2ijvoqdm"
    },
    {
      "op": "add",
      "notebookId": "notebook-1771515825877_9cmsogs35"
    },
    {
      "op": "add",
      "notebookId": "notebook-1771515826002_se55c2j3t"
    },
    {
      "op": "add",
      "notebookId": "notebook-1771515826135_hxgd7zhxi"
    },
    {
      "op": "add",
      "notebookId": "notebook-1771516217767_7wquqarsy"
    },
    {
      "op": "add",
      "notebookId": "notebook-1771516217926_jl610bu9d"
    },
    {
      "op": "add",
      "notebookId": "notebook-1771516218068_iv4u5gk1l"
    },
    {
      "op": "add",
      "notebookId": "notebook-1771516218216_dnvsa7uw8"
    },
    {
      "op": "add",
      "notebookId": "notebook-1771516218375_eeoe2ele6"
    },
    {
      "op": "add",
      "notebookId": "notebook-1771516218572_bohmwomzn"
    },
    {
      "op": "add",
      "notebookId": "notebook-1771516218735_1j1aaows4"
    },
    {
      "op": "add",
      "notebookId": "notebook-1771516218882_kiyeb3xax"
    },
    {
      "op": "add",
      "notebookId": "notebook-1771516219035_wrgm556z2"
    },
    {
      "op": "add",
      "notebookId": "notebook-1771516219213_85jvy09u6"
    },
    {
      "op": "add",
      "notebookId": "notebook-1771516219389_hv21id8am"
    },
    {
      "op": "add",
      "notebookId": "notebook-1771516219540_xwornorap"
    },
    {
      "op": "add",
      "notebookId": "notebook-1771516219690_9qehcnsq2"
    },
    {
      "op": "add",
      "notebookId": "notebook-1771516241433_9nd0jazox"
    },
    {
      "op": "add",
      "notebookId": "notebook-1771516264243_inj0p1yop"
    },
    {
      "op": "add",
      "notebookId": "notebook-1771516264408_avgvj4tyx"
    },
    {
      "op": "add",
      "notebookId": "notebook-1771516264548_jm7lqob06"
    },
    {
      "op": "update",
      "notebookId": "notebook-1771515825742_q2ijvoqdm",
      "previousNote": "职责: 正式 Web SSE 客户端子项目(PC + 手机协同).提供:\n1) Web UI(深色,移动优先)用于多服务端 Tab,会话,聊天,TODO,日志,Git 视图.\n2) 本地 Node 控制 API(同源)用于启动/停止 Snow SSE 进程,以及执行项目级 Git 操作.\n\n不该做什么:\n- 不替代 Snow CLI 核心(不改造对话执行/工具系统),仅作为可视化入口.\n- 不引入重前端框架(React/Vue/Angular)或复杂状态管理生态.\n- 不将认证扩展为对 Snow SSE 所有业务端点的逐请求鉴权(仅做 Web 入口门禁).\n\n接口摘要:\n- 输入:\n  - Snow SSE 服务端协议: GET /events,POST /message,POST /session/create,/session/load,GET /session/list,DELETE /session/:id,...\n  - 本地控制 API: GET/POST /api/servers*,以及 Git 相关端点(由本子项目定义).\n- 输出:\n  - 浏览器 UI + 对多个 Snow SSE 服务的连接与状态展示.\n\n依赖拓扑:\n- 依赖:\n  - Node.js runtime(本仓库既有环境).\n  - Snow SSE 服务进程(snow --sse/--sse-daemon).\n  - requirements/全平台网页版Snow SSE客户端需求.md(需求基线).\n- 被依赖: 无(独立子项目),但会被集成测试与文档引用.\n\n避坑指南:\n- 多服务端隔离: 每个 Tab 独立维护连接状态,会话列表,当前会话ID,YOLO 状态等,禁止共享可变状态导致串扰.\n- 协议向后兼容: 未知 SSE event.type 必须忽略,未知字段不得导致页面崩溃.\n- 最小依赖策略: 优先自研薄封装(路由,store),仅在明显降低维护成本时才引入小依赖.\n- 安全边界: 控制 API 只面向局域网开发使用,仍需基本登录门禁,避免误操作."
    },
    {
      "op": "update",
      "notebookId": "notebook-1771516219540_xwornorap",
      "previousNote": "职责: sse-client 内部协议合同(contracts).\n- Control API DTO: /api/servers*,/api/auth*,/api/git* 的 request/response.\n- Snow SSE DTO: 仅抽取本 Web 客户端实际消费的 SSEEvent 与 ClientMessage 结构(避免全量复制 server 端类型).\n\n不该做什么:\n- 不包含运行时逻辑.\n\n接口摘要:\n- 输出: TypeScript types.\n\n依赖拓扑:\n- 被依赖: server/routes,server/services,web/state,web/services.\n\n避坑指南:\n- DTO 向后兼容: 新增字段必须可选.\n- 命名必须与需求文档一致(timeoutMs,workDir 等)."
    },
    {
      "op": "add",
      "notebookId": "notebook-1771516802144_rjjhd9mej"
    },
    {
      "op": "update",
      "notebookId": "notebook-1771478149195_7bs0m83xf",
      "previousNote": "职责: 浏览器端 SSE 客户端示例(开发/联调用途),用于验证 Snow CLI 的 SSE 服务协议(connected,message,agent_list,agent_switched,error 等)与会话管理 API.\n\n不该做什么:\n- 不作为生产级前端架构,不引入复杂框架/构建工具.\n- 不实现服务端业务逻辑,仅消费协议并展示.\n\n接口摘要:\n- 输入: EventSource(/events) 事件流 + fetch(/message,/session/*,/response) 等 HTTP 调用.\n- 输出: DOM UI(聊天消息,状态,会话列表,主代理选择器) + 控制台/事件日志.\n\n依赖拓扑:\n- 依赖: source/api/sse-server.ts 的协议契约,source/utils/sse/sseManager.ts 的事件/错误码实现,docs/usage/zh/20.SSE服务模式.md,requirements/SSE客户端适配主代理.md.\n- 被依赖: 无(仅示例).\n\n避坑指南:\n- 兼容性: 必须对未知 event.type 静默忽略,避免服务端新增事件导致客户端崩溃.\n- 断线重连: 断线时必须清理 agents/currentAgentId/isSwitchingAgent 等连接态,并禁用选择器;但可选择保留 preferredAgentIdForNewSession,便于重连后新建会话继续使用预选主代理.\n- 主代理切换状态机: UI 不得仅凭 select change 更新 currentAgentId,必须等待 agent_switched 确认;切换失败(包括 error 无 errorCode)必须回滚到 lastConfirmedAgentId 并解锁 isSwitchingAgent/requestedAgentId,否则 UI 会卡死.\n- 会话边界: 切换主代理必须以 sessionId 为边界,客户端已知 currentSessionId 时必须随 switch_agent 一并发送,避免依赖连接绑定产生歧义."
    },
    {
      "op": "update",
      "notebookId": "notebook-1771478149329_cgfw81aim",
      "previousNote": "职责: 浏览器端 SSE 客户端示例的主逻辑.负责连接管理(EventSource),统一事件分发(handleEvent),消息发送(chat,abort,rollback,tool/user_question 响应,switch_agent),会话列表与当前会话状态维护,以及聊天 UI 渲染.\n\n主代理扩展(已落地的状态机约束):\n- 状态字段: agents,currentAgentId,lastConfirmedAgentId,isSwitchingAgent,requestedAgentId,preferredAgentIdForNewSession.\n- 原则: UI 不得仅凭 select change 就更新 currentAgentId,必须等待服务端 agent_switched 确认;失败则回滚到 lastConfirmedAgentId.\n\n接口摘要:\n- 输入: EventSource(/events) 推送(agent_list,agent_switched,error 等) + fetch(/message,/session/create,/session/load,/response).\n- 输出: DOM UI(主代理选择器,系统消息,事件日志).\n\n依赖拓扑:\n- 依赖: source/api/sse-server.ts 的协议契约,source/utils/sse/sseManager.ts 的错误码与事件实现,requirements/SSE客户端适配主代理.md.\n- 被依赖: 无(仅示例).\n\n避坑指南:\n- 防 UI 卡死: 切换中收到 error 时,即使 errorCode 缺失也必须执行回滚与解锁(currentAgentId=lastConfirmedAgentId,isSwitchingAgent=false,requestedAgentId=null,renderMainAgentSelect),否则选择器会永久 disabled.\n- 网络异常鲁棒: switch_agent 发送失败提示使用 error?.message || String(error),覆盖非 Error 抛出场景.\n- 预选逻辑: 无 sessionId 时允许预选 preferredAgentIdForNewSession,仅在新建会话时作为 initialAgentId 传给服务端,不要提前发送 switch_agent.\n- 向后兼容: handleEvent 必须对未知 event.type 静默忽略,避免服务端协议扩展导致示例崩溃."
    },
    {
      "op": "update",
      "notebookId": "notebook-1771515826002_se55c2j3t",
      "previousNote": "职责: 浏览器端 UI 与状态管理(移动优先,深色).负责:\n- 多服务端 Tab 管理,每 Tab 独立的会话侧栏 + 主区(聊天视图/Git 视图平级切换).\n- SSE 通信: 对每个服务端维护 EventSource 连接与事件分发,并通过 fetch 调用服务端 /message,/session/*,/response.\n- 交互弹窗: 审批弹窗,提问弹窗(单选/多选/编辑某条选项/自定义输入/取消).\n- TODO 常驻区(可滚动)与当前会话事件日志弹窗.\n\n不该做什么:\n- 不引入重框架或复杂编译链;优先使用原生 DOM + TypeScript 模块.\n- 不假设 SSE 事件类型固定不变;必须对未知 event.type 容错忽略.\n\n接口摘要:\n- 输入: SSEEvent 流 + 本地控制 API + Snow SSE HTTP API.\n- 输出: DOM 渲染与用户操作,以及对控制 API/Snow SSE 的请求.\n\n依赖拓扑:\n- 依赖: sse-client/src/shared/ 类型; sse-client/src/server/ 提供的同源控制 API.\n- 参考: source/test/sse-client/(联调示例),requirements/全平台网页版Snow SSE客户端需求.md(布局/验收).\n\n避坑指南:\n- 状态隔离: store 必须按 serverId(tab) 分片,避免跨 Tab 共享 currentSessionId.\n- 视图切换: Git 视图必须隐藏聊天消息区/TODO/日志按钮/底部状态栏,但保留顶部 Tab 与左侧会话栏.\n- 自适应布局: 宽屏消息区与 TODO 并排且比例自适应;窄屏上下堆叠."
    },
    {
      "op": "update",
      "notebookId": "notebook-1771516219035_wrgm556z2",
      "previousNote": "职责: 浏览器端通信层.\n- ControlApiClient: 调用同源控制 API(/api/servers*,/api/auth*,/api/git*).\n- SnowSseClient: 管理对单个 Snow SSE 服务端的连接(EventSource)与 HTTP 调用(/message,/session/*,/response).\n\n不该做什么:\n- 不做业务编排与 UI 逻辑(归 state/views).\n\n接口摘要:\n- 输入: server baseUrl,request DTO.\n- 输出: Promise/事件回调,以及标准化错误.\n\n依赖拓扑:\n- 依赖: shared/contracts,web/state.\n\n避坑指南:\n- 兼容性: 未知 SSE event.type 必须忽略.\n- 安全: baseUrl 仅允许本地/局域网白名单(可选),避免被恶意页面诱导访问外部.\n- 错误收敛: 对 fetch/EventSource error 做标准化,减少 UI 分支."
    }
  ],
  "93fe1069-f248-49c9-9f37-749174eb3713:120": [
    {
      "op": "update",
      "notebookId": "notebook-1771516219540_xwornorap",
      "previousNote": "职责: sse-client 内部协议合同(contracts).\n- Control API DTO: /api/auth*,/api/servers*,/api/git* 的 request/response.\n- Snow SSE DTO: 仅抽取 Web 客户端实际消费的 SSEEvent 与 ClientMessage 结构(避免全量复制 server 端类型).\n\n接口摘要:\n- 输出: TypeScript types,供 server/routes,server/services,web/state,web/services 共享.\n\n必含 DTO(建议按文件拆分):\n- ApiResponse<T>: `{ success: boolean, data?: T, errorCode?: string, message?: string }`.\n- Auth:\n  - LoginRequest `{ password: string }`\n  - LoginResponse `ApiResponse<{ loggedIn: true }>`\n  - MeResponse `ApiResponse<{ loggedIn: boolean }>`\n- Servers:\n  - ServerInfo `{ serverId: string, workDir: string, port: number, timeoutMs: number, startedAt: number, displayName?: string }`\n  - StartRequest `{ workDir: string, port: number, timeoutMs: number }`\n  - ListResponse `ApiResponse<{ servers: ServerInfo[] }>`\n- Git(项目级,以 workDir 或 serverId 作为隔离边界):\n  - StatusResponse(含 staged/unstaged/untracked 列表)\n  - Stage/Unstage request(文件路径必须是相对路径)\n  - DiffResponse(第一阶段建议 unified diff text)\n  - CommitRequest `{ message: string }`\n  - InitResponse(仓库未初始化时的动作)\n\n依赖拓扑:\n- 被依赖: server/routes,server/services,web/state,web/services.\n\n避坑指南:\n- DTO 向后兼容: 新增字段必须可选,避免破坏旧页面/旧 server.\n- 命名与需求一致: timeoutMs/workDir 等字段名必须与 requirements 口径一致.\n- 安全字段: 对 filePath 等必须明确约束(相对路径 + 白名单校验),并在 DTO 文档注释中写清."
    },
    {
      "op": "update",
      "notebookId": "notebook-1771516217926_jl610bu9d",
      "previousNote": "职责: 控制面 API 路由层.\n- 定义 /api/servers*,/api/auth*,/api/git* 等端点.\n- 做请求参数校验与 DTO 映射,调用 services 层,并返回统一响应结构.\n\n不该做什么:\n- 不直接调用 child_process 执行 snow/git(归 services).\n- 不读写持久化存储文件(归 storage).\n\n接口摘要:\n- 输入: HTTP 请求(已解析的 JSON/body/cookie),shared/contracts 的 DTO.\n- 输出: ApiResponse JSON.\n\n依赖拓扑:\n- 依赖: services/*,storage/*(只通过 service 访问),shared/contracts/*.\n- 被依赖: http/*.\n\n避坑指南:\n- 参数校验必须覆盖: workDir 必须是绝对路径,port/timeoutMs 必须是合法整数范围,避免命令注入与崩溃.\n- 统一错误码: 与 requirements/全平台网页版Snow SSE客户端需求.md 中的 errorCode 保持一致,新增必须记录在 requirements/ 或 shared/errors."
    },
    {
      "op": "update",
      "notebookId": "notebook-1771516218068_iv4u5gk1l",
      "previousNote": "职责: 控制面业务服务层(核心逻辑).\n- 进程管理: 启动/停止/枚举 Snow SSE 进程,维护 workDir <-> port <-> pid 的状态.\n- Git 服务: 在指定 workDir 执行安全的 git 命令(init,status,stage/unstage,diff,commit).\n- 认证服务: 读取 ~/.snow/sse-config.json 校验密码,生成并验证 Web 会话 token.\n\n不该做什么:\n- 不直接处理 HTTP 细节(归 routes/http).\n- 不直接依赖浏览器 DOM 或 UI 状态.\n\n接口摘要:\n- 输入: 结构化参数(workDir,port,timeoutMs,paths,message等).\n- 输出: 结构化结果(servers 列表,git 状态,diff 文本,commit 结果)或抛出领域错误.\n\n依赖拓扑:\n- 依赖: storage/*(持久化),utils/*(校验/安全),shared/errors.\n- 被依赖: routes/*.\n\n避坑指南:\n- 跨平台: Windows 路径与 shell 行为差异,必须尽量使用 spawn/execFile 参数数组,避免拼接 shell 字符串.\n- 并发: 同一 workDir 的 start/stop 与 git 操作要有互斥/队列,避免状态乱序.\n- 可观测性: 建议提供最小日志,但不要输出敏感信息(密码,token)."
    },
    {
      "op": "update",
      "notebookId": "notebook-1771516218216_dnvsa7uw8",
      "previousNote": "职责: 控制面持久化与状态存储.\n- 保存运行中服务端列表(端口,pid,workDir,displayName,lastSeen)以支持页面刷新后恢复.\n- 保存认证会话(浏览器会话级)与过期清理.\n\n不该做什么:\n- 不做业务决策(归 services).\n- 不在此层执行 git/snow.\n\n接口摘要:\n- 输入: servers/authSessions 等实体.\n- 输出: 读写到本地 JSON 文件(建议存放 ~/.snow/sse-web-client/* 或 sse-client 自己的 data 目录,需在实现时确定).\n\n依赖拓扑:\n- 被依赖: services/*.\n\n避坑指南:\n- 原子写: 写文件必须使用临时文件 + rename,避免进程中断造成损坏.\n- 兼容升级: 存储 schema 新增字段必须可选,并提供默认值."
    },
    {
      "op": "update",
      "notebookId": "notebook-1771516219035_wrgm556z2",
      "previousNote": "职责: 浏览器端通信层.\n- ControlApiClient: 调用同源控制 API(/api/auth/*,/api/servers*,/api/git/*).\n- SnowSseClient: 管理对单个 Snow SSE 服务端的连接(EventSource)与 HTTP 调用(如 /message,/session/*).\n\n不该做什么:\n- 不做业务编排与 UI 逻辑(归 state/views).\n\n接口摘要:\n- 输入: server baseUrl,request DTO.\n- 输出: Promise/事件回调,以及标准化错误.\n\n依赖拓扑:\n- 依赖: shared/contracts,web/state.\n\n避坑指南:\n- 兼容性: 未知 SSE event.type 必须忽略.\n- 安全: baseUrl 仅允许本地/局域网白名单(可选),避免被恶意页面诱导访问外部.\n- 错误收敛: 对 fetch/EventSource error 做标准化,减少 UI 分支."
    },
    {
      "op": "update",
      "notebookId": "notebook-1771516264408_avgvj4tyx",
      "previousNote": "职责: Git diff 展示组件.\n- 支持宽屏双列对比,窄屏单列.\n- 支持文件级 diff 切换与基础高亮(可选).\n\n不该做什么:\n- 不执行 git 命令(只展示文本/结构化 diff).\n\n接口摘要:\n- 输入: unified diff text 或 server 侧结构化 diff(二选一,建议先 unified text).\n- 输出: DOM.\n\n依赖拓扑:\n- 被依赖: web/views/GitView.\n\n避坑指南:\n- diff 文本可能很大,必须支持按需渲染/分块(可后置到性能里程碑).\n- 高亮依赖可选,不要为了高亮引入重量级编辑器(如 Monaco)."
    },
    {
      "op": "update",
      "notebookId": "notebook-1771516219690_9qehcnsq2",
      "previousNote": "职责: sse-client 内部错误码与错误对象规范.\n- 定义 Control API errorCode 枚举(servers/auth/git).\n- 定义统一的 DomainError(ApiError) 结构,用于 server/services 抛出并在 routes 层映射.\n\n不该做什么:\n- 不引入复杂国际化/错误堆栈收集系统.\n\n接口摘要:\n- 输入: 原始错误.\n- 输出: 结构化错误({errorCode,message,details?}).\n\n依赖拓扑:\n- 被依赖: server/services,server/routes,web/services.\n\n避坑指南:\n- message 面向用户时应尽量中文且可理解,但保留 details 供调试.\n- errorCode 稳定性: 一旦发布不可随意更名,否则前端映射会失效."
    },
    {
      "op": "update",
      "notebookId": "notebook-1771516217767_7wquqarsy",
      "previousNote": "职责: sse-client 控制面 HTTP 服务内核.\n- 创建并启动本地 HTTP server(同源),托管静态 Web 资源,并将 /api/* 路由分发给 routes 层.\n- 处理基础中间件: JSON body 解析,错误捕获,统一响应封装,CORS/缓存头(按需求),以及简易 session/cookie.\n\n不该做什么:\n- 不直接实现业务逻辑(启动进程/Git 操作/认证校验),仅做请求调度与通用能力.\n- 不引入重量级 Web 框架(Express/Koa/Fastify)除非后续明确收益大于维护成本.\n\n接口摘要:\n- 输入: Node http.IncomingMessage/ServerResponse.\n- 输出: 静态资源响应或 JSON(统一 ApiResponse).\n\n依赖拓扑:\n- 上游: sse-client/src/web/ 通过同源访问.\n- 下游: routes/*,shared/contracts/*.\n\n避坑指南:\n- 安全: 任何来自浏览器的 path/workDir/filePath 都必须在 routes/service 层做严格校验,HTTP 层不可直接拼接命令行.\n- 错误一致性: 必须把异常映射为 {success:false,errorCode,message} 防止前端分支爆炸."
    },
    {
      "op": "update",
      "notebookId": "notebook-1771516218882_kiyeb3xax",
      "previousNote": "职责: 浏览器端状态层(轻量 store).\n- 按 serverId 分片保存状态: 连接信息,SSE 事件流,会话列表,当前会话ID,YOLO 状态,profile/model(按需求),Git 状态.\n- 提供 actions/reducers 或 command-style API,保证状态更新可追踪.\n\n不该做什么:\n- 不操作 DOM(归 views/components).\n- 不直接做网络请求(归 services).\n\n接口摘要:\n- 输入: action(payload),来自 services 的事件.\n- 输出: 新 state + subscribe 通知.\n\n依赖拓扑:\n- 依赖: shared/contracts 事件/DTO 类型.\n- 被依赖: views/*,services/*.\n\n避坑指南:\n- 防串扰: 必须保证每个 Tab 的状态完全隔离,禁止复用单例 currentSessionId.\n- 断线重连: 必须在 connection close 时清理 session 绑定与 agent 列表,等待新 agent_list 恢复."
    },
    {
      "op": "update",
      "notebookId": "notebook-1771516218572_bohmwomzn",
      "previousNote": "职责: 浏览器端页面级视图(无框架组件化).\n- ChatView: 聊天视图布局(会话栏 + 聊天区 + TODO + 状态栏).\n- GitView: Git 视图布局(保留顶部 Tab 与左侧会话栏,隐藏聊天/TODO/日志/状态栏).\n- LoginView/ServerManagerModal/SessionManagerModal/Dialogs 等.\n\n不该做什么:\n- 不直接持有跨 Tab 的业务状态(归 state/store).\n- 不直接调用 fetch/EventSource(归 services).\n\n接口摘要:\n- 输入: state slice + view-model(纯数据) + 事件回调.\n- 输出: DOM 更新(建议以 id/class + render 函数为主).\n\n依赖拓扑:\n- 依赖: components/*,styles/*,state/*,services/*.\n\n避坑指南:\n- 视图切换规则必须严格按 requirements: Git 视图下隐藏区域,聊天视图下 TODO 常驻且可滚动.\n- 无障碍: modal 打开时应锁定底层滚动与焦点,避免手机端滚动穿透."
    },
    {
      "op": "update",
      "notebookId": "notebook-1771516218375_eeoe2ele6",
      "previousNote": "职责: 控制面通用工具.\n- 参数与路径校验(绝对路径,禁止路径穿越,相对文件路径白名单).\n- 端口扫描与占用检测.\n- child_process 调用封装(spawn/execFile),统一超时,stdout/stderr 截断.\n\n不该做什么:\n- 不依赖 routes/http(保持纯函数/无副作用为主).\n\n接口摘要:\n- 输入: 字符串/数字.\n- 输出: 校验后的值或抛错.\n\n依赖拓扑:\n- 被依赖: services/*(主要),routes/*(少量校验辅助).\n\n避坑指南:\n- 任何来自 web 的字符串都必须经过这里的校验,禁止在 service 内部临时拼 patch."
    },
    {
      "op": "update",
      "notebookId": "notebook-1771516802144_rjjhd9mej",
      "previousNote": "⚠️ 计划书更新提醒: 当前环境对 `.md` 文件的直接编辑被权限限制,因此本笔记用于记录\"建议的 CurrentTaskPlan 更新方向\".\n\n建议将 CurrentTaskPlan.md 从\"测试客户端适配主代理\"切换为\"正式 Web SSE 客户端(sse-client)\"计划,并覆盖:\n- 需求基线: requirements/全平台网页版Snow SSE客户端需求.md\n- 目标: 建立 sse-client 子项目骨架 + 同源控制 API(/api/servers*) + 登录门禁 + 最小 ChatView 骨架.\n- 分层与目录: shared/contracts,server/routes/services/storage,web/state/services/views/components.\n- 里程碑: M0 骨架+contracts -> M1 登录+servers 管理 -> M2 单服务端聊天 -> M3 弹窗+TODO+日志 -> M4 多服务端+会话管理 -> M5 Git 视图.\n\n如需我输出可直接粘贴替换的完整 CurrentTaskPlan.md 内容,请告知,我会在聊天回复中给出可复制版本."
    },
    {
      "op": "update",
      "notebookId": "notebook-1771515825877_9cmsogs35",
      "previousNote": "职责: 本地 Node 控制面(同源).负责:\n- 提供 /api/servers* 等控制 API,启动/停止/列举多个 Snow SSE 进程(按 workDir 隔离).\n- 承载 Web 入口登录门禁(基于 ~/.snow/sse-config.json).\n- 对每个 workDir 提供 Git 基础能力 API(init,status,stage/unstage,diff,commit).\n- 静态资源托管: 为手机端提供同一 URL 访问的 Web UI.\n\n不该做什么:\n- 不实现 Snow SSE 的业务逻辑(聊天/会话/工具执行),不替代 Snow SSE 进程.\n- 不把 Git 能力塞进 Snow SSE 服务端(除非后续明确决策需要上游统一).\n\n接口摘要:\n- 输入: 浏览器 fetch 请求(同源),以及本机 shell/child_process 执行 snow 与 git.\n- 输出: JSON 响应(统一 {success,errorCode,message,data}).\n\n依赖拓扑:\n- 上游: sse-client/src/web/ 通过同源 API 调用.\n- 下游: Node child_process,fs,path,os; Snow CLI 可执行文件(snow); git 可执行文件.\n\n避坑指南:\n- 进程管理: 必须记录 pid/port/workDir 的映射,并处理崩溃/端口占用/重复启动.\n- 端口扫描: 按需求从 3000 起或 max+1,最多尝试 100 次.\n- Git 命令安全: 所有入参必须做严格校验(只允许相对路径文件名,禁止任意命令注入).\n- 跨平台: Windows 路径与 Git Bash 差异,必须统一用 Node path 处理,不要拼接 shell 字符串."
    },
    {
      "op": "update",
      "notebookId": "notebook-1771515826002_se55c2j3t",
      "previousNote": "职责: 浏览器端 UI 与状态管理(移动优先,深色).负责:\n- 多服务端 Tab 管理,每 Tab 独立的会话侧栏 + 主区(聊天视图/Git 视图平级切换).\n- SSE 通信: 对每个服务端维护 EventSource 连接与事件分发,并通过 fetch 调用服务端 /message,/session/* 等 HTTP API.\n- 交互弹窗: 审批弹窗,提问弹窗(单选/多选/编辑某条选项/自定义输入/取消).\n- TODO 常驻区(可滚动)与当前会话事件日志弹窗(仅展示已收到 SSE 事件流).\n\n不该做什么:\n- 不引入重框架或复杂编译链;优先使用原生 DOM + TypeScript 模块.\n- 不假设 SSE 事件类型固定不变;必须对未知 event.type 容错忽略.\n\n接口摘要:\n- 输入: SSEEvent 流 + 本地控制 API + Snow SSE HTTP API.\n- 输出: DOM 渲染与用户操作,以及对控制 API/Snow SSE 的请求.\n\n依赖拓扑:\n- 依赖: sse-client/src/shared/ 类型; sse-client/src/server/ 提供的同源控制 API.\n- 参考: source/test/sse-client/(联调示例),requirements/全平台网页版Snow SSE客户端需求.md(布局/验收).\n\n避坑指南:\n- 状态隔离: store 必须按 serverId(tab) 分片,避免跨 Tab 共享 currentSessionId.\n- 视图切换: Git 视图必须隐藏聊天消息区/TODO/日志按钮/底部状态栏,但保留顶部 Tab 与左侧会话栏.\n- 自适应布局: 宽屏消息区与 TODO 并排且比例自适应;窄屏上下堆叠."
    },
    {
      "op": "update",
      "notebookId": "notebook-1771515826135_hxgd7zhxi",
      "previousNote": "职责: sse-client 子项目内部共享的类型与协议定义.\n- 本地控制 API 的请求/响应 DTO.\n- Web UI 与 server 侧共享的 errorCode 枚举与最小数据结构.\n\n不该做什么:\n- 不直接依赖 Snow CLI 的 source/api 类型(避免跨包耦合与编译复杂度).\n- 不放入任何运行时逻辑或 Node 特有实现.\n\n接口摘要:\n- 输入: 需求文档中的控制 API 契约.\n- 输出: 稳定的 TypeScript 类型,供 web/server 双端编译期约束.\n\n避坑指南:\n- 向后兼容: DTO 新增字段必须可选,避免破坏旧前端/旧 server 的编译与运行.\n- 字段命名与需求文档保持一致(如 timeoutMs)."
    },
    {
      "op": "update",
      "notebookId": "notebook-1771516217767_7wquqarsy",
      "previousNote": "职责: sse-client 控制面 HTTP 服务内核.\n- 创建并启动本地 HTTP server(同源),托管静态 Web 资源,并将 /api/* 路由分发给 routes 层.\n- 处理基础中间件: JSON body 解析,错误捕获,统一响应封装,CORS/缓存头(按需求),以及 session/cookie.\n\n接口摘要:\n- 输入: Node http.IncomingMessage/ServerResponse.\n- 输出: 静态资源响应或 JSON(ApiResponse).\n\n与本轮需求强相关的约束:\n- Auth 返回口径固定为 HTTP 200 + success 字段;HTTP 层不得擅自把 invalid_password 或未登录映射为 401/403.\n- 登录态必须浏览器会话级:\n  - 推荐使用 HttpOnly session cookie,且不设置 expires/max-age(浏览器关闭即失效).\n  - 禁止引导前端使用 localStorage 保存 token.\n\n依赖拓扑:\n- 上游: sse-client/src/web/ 同源访问.\n- 下游: routes/*,shared/contracts/*.\n\n避坑指南:\n- 安全: HTTP 层不可直接拼接命令行或路径,所有校验与执行在 routes/services.\n- JSON 解析必须有 size limit(建议 1MB)避免误操作导致内存膨胀.\n- cookie 解析与设置要集中封装,避免各路由重复实现造成不一致."
    },
    {
      "op": "update",
      "notebookId": "notebook-1771516218068_iv4u5gk1l",
      "previousNote": "职责: 控制面业务服务层(核心逻辑).\n- 进程管理: 启动/停止/枚举 Snow SSE 进程,维护 workDir <-> port <-> pid 的状态.\n- Git 服务: 在指定 workDir 执行安全的 git 命令(init,status,stage/unstage,diff,commit).\n- 认证服务: 读取 ~/.snow/sse-config.json 校验密码,并维护浏览器会话级登录态.\n\n接口摘要:\n- 输入: 结构化参数(workDir,port,timeoutMs,filePaths,message,password等).\n- 输出: 结构化结果或抛出领域错误(DomainError).\n\n新增必须落实的架构约束(本轮需求定稿):\n1) /api/servers/start 并发串行:\n- 必须在 services 层实现全局互斥/队列(StartRequestQueue/Mutex).\n- 关键区包含: 端口扫描 + 启动 + 写入运行中列表.\n- 后一个 start 必须等待前一个完成后再扫描端口,避免端口竞争与状态乱序.\n2) Auth 登录态(浏览器会话级):\n- 推荐: server 生成 session token,通过 HttpOnly session cookie 下发(无 expires),浏览器关闭即失效.\n- server 侧会话存储推荐仅内存(Map + TTL),不落盘,避免跨会话残留造成误判.\n- me 未登录返回 success=true + isLoggedIn=false(不抛错),login 密码错误返回 invalid_password.\n3) Git 修改区口径固定:\n- status 计算必须包含: modified-unstaged + untracked + deleted-unstaged.\n- deleted-unstaged 在 git 层通常来自 diff-index 或 status --porcelain,必须显式覆盖.\n\n依赖拓扑:\n- 依赖: server/storage/*(运行中 servers 可持久化),server/utils/*(校验/安全/child_process/队列),shared/errors.\n- 被依赖: server/routes/*.\n\n避坑指南:\n- 跨平台: Windows 路径与 shell 行为差异,必须尽量使用 spawn/execFile 参数数组,避免拼接 shell 字符串.\n- 并发: 除 start 串行外,同一 workDir 的 stop 与 git 操作也建议互斥,至少避免同目录同时执行 git 与 stop 导致锁冲突.\n- 可观测性: 日志中禁止输出 password,session token;错误 details 仅用于调试."
    },
    {
      "op": "update",
      "notebookId": "notebook-1771516217926_jl610bu9d",
      "previousNote": "职责: 控制面 API 路由层.定义 /api/* 端点,做请求参数校验与 DTO 映射,调用 services 层,并返回统一响应结构(ApiResponse).\n\n接口摘要:\n- 输入: HTTP 请求(JSON body,cookie).\n- 输出: HTTP 200 JSON:\n  - 成功: { success:true,data? }.\n  - 失败: { success:false,errorCode,message }.\n\n关键契约(必须严格遵守):\n- Auth:\n  - POST /api/auth/login,/api/auth/logout,GET /api/auth/me.\n  - 禁止使用 401/403 表达未登录与密码错误(需求固定为 HTTP 200 + success 标志).\n  - login 密码错误必须返回: success=false,errorCode=invalid_password,message=密码错误.\n  - me 未登录必须返回: success=true,data:{isLoggedIn:false}.\n- Servers:\n  - POST /api/servers/start 必须接入串行队列(实现层在 services),routes 不得并发触发端口扫描.\n- Git:\n  - 修改区范围固定包含: modified-unstaged + untracked + deleted-unstaged.\n\n依赖拓扑:\n- 依赖: server/services/*,server/utils/*,shared/contracts/*,shared/errors.\n- 被依赖: server/http/*.\n\n避坑指南:\n- 参数校验必须覆盖: workDir 必须绝对路径且禁止路径穿越;port/timeoutMs 必须为合法整数范围;git filePath 必须是相对路径.\n- 错误映射必须统一: services 抛 DomainError -> routes 映射为 {success:false,errorCode,message}.\n- 安全: routes 层禁止拼接 shell 命令,所有执行都在 services 层且必须使用参数数组(execFile/spawn)."
    },
    {
      "op": "update",
      "notebookId": "notebook-1771516218216_dnvsa7uw8",
      "previousNote": "职责: 控制面持久化与状态存储.\n\n建议拆分存储语义(避免与需求冲突):\n- servers 存储(可落盘): 保存运行中服务端列表(端口,pid,workDir,displayName,startedAt,lastSeen),用于页面刷新后恢复 UI.\n- auth sessions 存储(默认不落盘): 浏览器会话级登录态建议仅内存持有,由 session cookie 驱动,浏览器关闭即失效.\n\n接口摘要:\n- 输入: servers 等实体.\n- 输出:\n  - servers: 读写本地 JSON 文件(建议 ~/.snow/sse-web-client/servers.json).\n  - authSessions: in-memory Map(token->metadata),可选 TTL 清理.\n\n依赖拓扑:\n- 被依赖: server/services/*.\n\n避坑指南:\n- 原子写: 写文件必须使用临时文件 + rename,避免进程中断造成损坏.\n- schema 兼容: 新增字段必须可选并提供默认值.\n- 安全: 禁止把明文 password 或 session token 写入磁盘;即使要调试,也应通过日志开关且默认关闭."
    },
    {
      "op": "update",
      "notebookId": "notebook-1771516218375_eeoe2ele6",
      "previousNote": "职责: 控制面通用工具.\n- 参数与路径校验(绝对路径,禁止路径穿越,相对文件路径白名单).\n- 端口扫描与占用检测.\n- child_process 调用封装(spawn/execFile),统一超时,stdout/stderr 截断.\n- 并发互斥/队列工具(建议在此目录提供 Mutex/Queue,供 services/start 串行化复用).\n\n接口摘要:\n- 输入: 字符串/数字/命令参数.\n- 输出: 校验后的值或抛错.\n\n与本轮需求强相关的约束:\n- 端口扫描必须可被串行队列保护,避免并发 start 互相抢端口.\n- workDir 必须绝对路径,且禁止 '..' 穿越;手机端输入 Windows 路径时需兼容 'F:/...' 形式.\n\n依赖拓扑:\n- 被依赖: services/*(主要),routes/*(少量校验辅助).\n\n避坑指南:\n- 任何来自 web 的字符串都必须经过这里的校验,禁止在 service 内部临时拼 patch.\n- child_process 必须使用参数数组,禁止 shell:true.\n- Queue/Mutex 实现必须保证 await 完整释放(try/finally),否则会导致 start 永久阻塞."
    },
    {
      "op": "update",
      "notebookId": "notebook-1771516219035_wrgm556z2",
      "previousNote": "职责: 浏览器端通信层.\n- ControlApiClient: 调用同源控制 API(/api/auth/*,/api/servers*,/api/git/*).\n- SnowSseClient: 管理对单个 Snow SSE 服务端的连接(EventSource)与 HTTP 调用(/message,/session/* 等).\n\n接口摘要:\n- 输入: baseUrl,request DTO.\n- 输出: Promise/事件回调,以及标准化错误.\n\n必须遵守的认证与状态约束:\n- 登录态以 GET /api/auth/me 为唯一事实源.\n- 禁止使用 localStorage 持久化登录态;页面刷新后可直接调用 me 判断,未登录则回到 LoginView.\n- 推荐服务端使用 HttpOnly session cookie,浏览器端 fetch 不需要手动保存 token(同源自动携带 cookie).\n\n依赖拓扑:\n- 依赖: shared/contracts,web/state.\n- 被依赖: web/views/*.\n\n避坑指南:\n- 兼容性: unknown SSE event.type 必须在统一分发层忽略.\n- 错误收敛: 对 fetch/EventSource error 做标准化,未知 errorCode 必须回退展示 message.\n- me 未登录不应走错误分支(HTTP 200 + success=true + isLoggedIn=false),避免 UI 分支爆炸."
    },
    {
      "op": "update",
      "notebookId": "notebook-1771516218572_bohmwomzn",
      "previousNote": "职责: 浏览器端页面级视图(无框架组件化).\n- ChatView: 会话栏 + 聊天区 + TODO + 状态栏(聊天视图下展示).\n- GitView: Git 主区(保留顶部 Tab 与左侧会话栏,隐藏聊天/TODO/日志/状态栏).\n- LoginView/ServerManagerModal/SessionManagerModal/Dialogs 等.\n\n接口摘要:\n- 输入: state slice + view-model(纯数据) + 事件回调.\n- 输出: DOM 更新(render functions).\n\n与本轮需求强相关的 UI 规则:\n- 登录态: 页面启动先调用 GET /api/auth/me,未登录则只渲染 LoginView;禁止用 localStorage 绕过.\n- me 未登录属于正常分支(success=true,isLoggedIn=false),不可展示为错误 toast.\n- Git DiffViewer breakpoint 固定 1200px(>= 双列,< 单列).\n\n依赖拓扑:\n- 依赖: components/*,styles/*,state/*,services/*.\n\n避坑指南:\n- 视图切换口径必须严格按 requirements: Git 视图下隐藏聊天消息区,TODO 区,日志按钮与底部状态栏,但保留顶部 Tab 与左侧会话栏.\n- modal 打开时应锁定底层滚动与焦点,避免手机端滚动穿透.\n- 同一 UI 控件不得跨 serverId 读写状态,避免 Tab 串扰."
    }
  ],
  "e3a3263d-ae81-435b-99c6-35e994cb9a1b:57": [
    {
      "op": "add",
      "notebookId": "notebook-1771676257168_wqpfaa3uf"
    },
    {
      "op": "update",
      "notebookId": "notebook-1771515649312_x6aph0c29",
      "previousNote": "职责: 正式 Web SSE 客户端(sse-client/)的唯一需求基线(SSoT).定义信息架构,UI 布局规则,本地控制 API 契约,以及验收标准.\n\n接口摘要:\n- 输入: 用户目标与现有 SSE 服务端能力边界.\n- 输出:\n  - Web 客户端必须实现的页面结构(聊天视图 vs Git 视图平级切换),弹窗交互(审批/提问),以及 Git 基础能力.\n  - 本地控制 API 的最小端点集合(/api/servers...).\n\n依赖拓扑:\n- 被依赖: sse-client/ 子项目的 UI/状态/控制 API 设计与实现.\n- 参考: docs/usage/zh/20.SSE服务模式.md(服务端协议),requirements/SSE客户端适配主代理.md(主代理事件/错误码).\n\n避坑指南:\n- 本文档为最终口径,与任何旧描述冲突时以本文档为准.\n- Git 视图隐藏范围,日志弹窗仅事件流,TODO 常驻等规则必须在实现中严格对齐.\n- 认证口径为 Web 入口门禁,不是要求改造 Snow SSE 各业务端点逐请求鉴权."
    },
    {
      "op": "update",
      "notebookId": "notebook-1771515826002_se55c2j3t",
      "previousNote": "职责: 浏览器端 UI 与状态管理(移动优先,深色).负责:\n- 多服务端 Tab 管理,每 Tab 独立的会话侧栏 + 主区(聊天视图/Git 视图平级切换).\n- SSE 通信: 每个服务端维护 EventSource 连接与事件分发,并通过 fetch 调用服务端 /message,/session/* 等 HTTP API.\n- 交互弹窗: 审批弹窗,提问弹窗(单选/多选/编辑某条选项/自定义输入/取消).\n- TODO 常驻区(可滚动)与当前会话事件日志弹窗(仅展示已收到 SSE 事件流).\n\n不该做什么:\n- 不引入重框架或复杂编译链;优先原生 DOM + TypeScript 模块.\n- 不假设 SSE 事件类型固定不变;必须对未知 event.type 容错忽略.\n\n关键架构约束(本轮定稿,必须落实):\n1) 登录态与门禁:\n- 登录态以 GET /api/auth/me 为唯一事实源.\n- 禁止 localStorage 持久化登录态.\n- 页面启动/刷新必须先调用 me: 未登录(isLoggedIn=false)则仅展示 LoginView.\n- login 密码错误是 HTTP 200 + success=false,errorCode=invalid_password,message=密码错误,必须走业务错误分支.\n2) 多服务端隔离:\n- 任意可变状态必须以 serverId(tab) 分片,禁止跨 Tab 共享 currentSessionId/currentAgentId 等.\n3) Git DiffViewer 断点固定:\n- >=1200px 双列,<1200px 单列.\n\n接口摘要:\n- 输入: SSEEvent 流 + 本地控制 API + Snow SSE HTTP API.\n- 输出: DOM 渲染与用户操作,以及对控制 API/Snow SSE 的请求.\n\n依赖拓扑:\n- 依赖: sse-client/src/shared/ 类型; sse-client/src/server/ 提供的同源控制 API.\n- 参考: source/test/sse-client/(联调示例),requirements/全平台网页版Snow SSE客户端需求.md.\n\n避坑指南:\n- unknown SSE event.type 必须在统一分发层忽略,不要在各视图重复写 switch.\n- 日志弹窗禁止新增后端查询接口,仅使用已接收事件流(需求排除项)."
    }
  ],
  "f3c3e07f-7048-4659-a1fb-13ea99fce728:82": [
    {
      "op": "add",
      "notebookId": "notebook-1771680023167_oigbzrqy6"
    },
    {
      "op": "add",
      "notebookId": "notebook-1771680042939_1t1yyut6l"
    },
    {
      "op": "update",
      "notebookId": "notebook-1771676257168_wqpfaa3uf",
      "previousNote": "职责: Web 控制面(无框架)的核心渲染与 DOM 事件绑定层,把 state/view-model 渲染为页面 HTML,并在 render 后进行一次性事件绑定.\n\n边界(本阶段已固化,验收口径):\n- 服务端切换: 禁止使用下拉框(serverSelect).服务选择仅通过顶部 server tabs.\n- 连接控制区(Tab 连接控制): 每个 Tab 下只允许 2 个按钮:\n  1) 重连(reconnectBtn).\n  2) 关闭(closeServerBtn).\n- 禁止出现/绑定\"连接 SSE\"按钮(connectBtn).任何连接恢复动作统一走\"重连\"语义.\n- closeServerBtn 必须调用 stopCurrentServer(关闭当前 Tab 对应的服务端),不得误连 stopAll.\n- \"停止全部\"(stopAllServersBtn)属于服务管理区,不属于 Tab 连接控制区,避免验收歧义.\n\n接口摘要:\n- 输入: state(包含 control.selectedServerId,control.actionLoading,connection.status 等).\n- 输出: 字符串 HTML + DOM 事件监听(调用 actions.*).\n\n依赖拓扑:\n- 依赖: web/state(actions,state shape),web/utils(escapeHtml,byId).\n- 被依赖: web/app.js(或入口)触发 render/rehydrate.\n\n避坑指南:\n- 事件绑定必须与 DOM id 完全一致,render 变更后需同步调整绑定,避免幽灵按钮/重复绑定.\n- 禁止把 stopAll 放进 Tab 区域(无论 UI 还是事件),否则会破坏多服务端隔离验收口径."
    },
    {
      "op": "add",
      "notebookId": "notebook-1771680100313_1lnm7kgko"
    },
    {
      "op": "add",
      "notebookId": "notebook-1771680124830_riwy79zc9"
    },
    {
      "op": "add",
      "notebookId": "notebook-1771680138288_w3359bvgo"
    }
  ],
  "3cbd409e-556e-4d54-99df-31ffb7c414a3:176": [
    {
      "op": "update",
      "notebookId": "notebook-1771495044055_cbcvm3sjp",
      "previousNote": "职责: API/HTTP 层.承载 Snow CLI 的对外 HTTP API,包含 SSE 协议入口(/events)与会话管理端点(/session/create,/session/load 等).本层聚焦\"协议与连接生命周期\",不承载会话业务状态.\n\n接口摘要:\n- 输入: 浏览器/客户端通过 HTTP(SSE/EventSource + fetch)发送的请求.\n- 输出: SSEEvent 流与 JSON 响应.\n\n依赖拓扑:\n- 下游: source/utils/sse/sseManager.ts(业务编排与消息处理),source/utils/session/sessionManager.ts(会话创建/加载).\n\n避坑指南:\n- 职责边界: 不在 API 层实现主代理切换/会话级状态机,仅转发到 SSEManager.\n- 会话绑定时序: /session/create,/session/load 完成 bindSessionToConnection 后,必须通过 sessionBoundHandler 通知业务层同步映射,否则会触发 switch_agent 的 session_not_found 误判.\n- 回调内禁止反向调用 bindSessionToConnection,避免循环或覆盖绑定."
    },
    {
      "op": "update",
      "notebookId": "notebook-1770694883398_3ow0urpes",
      "previousNote": "职责: Anthropic API 适配器,负责将内部 ChatMessage 格式转换为 Anthropic 消息格式,并实现 Anthropic 流式响应的 SSE 解析与产出.\n接口摘要:\n- createStreamingAnthropicCompletion(options,abortSignal,onRetry) -> AsyncGenerator<AnthropicStreamChunk>.\n- parseSSEStream(reader,abortSignal?) 逐次 reader.read() 解码,解析 SSE data 行 JSON 并 yield.\n依赖拓扑:\n- 上游: 对话执行层(summaryAgent/useConversation 等)选择该适配器.\n- 下游: withRetryGenerator(统一重试),utils/core/streamGuards(createIdleTimeoutGuard,StreamIdleTimeoutError),utils/core/retryUtils(stream interruption 分类),parseJsonWithFix(JSON 修复),logger/proxy/version/usageLogger.\n\n架构要点(流式API保护模式):\n- MUST 接入 utils/core/streamGuards.ts 的 createIdleTimeoutGuard,统一实现 idle timeout(固定 180000ms) + abandoned 丢弃,避免在适配器内复制 setTimeout/Promise.race.\n- MUST 在 parseSSEStream 内部处理 abortSignal: abort 时调用 guard.abandon() 并 return,确保用户中断后旧连接延迟 chunk 不外泄.\n- 竞态条件防护: 每次 reader.read() 后 MUST guard.touch();任何 yield 之前 MUST 检查 guard.isAbandoned();reader.cancel() 不可靠,guard.isAbandoned() 是最终屏障.\n- MUST 在读取循环中调用 guard.getTimeoutError() 检查并在循环上下文 throw,确保超时异常被 parseSSEStream 的 try/catch 捕获并进入 withRetryGenerator 重试;禁止在定时器回调里直接 throw 指望外层 try/catch 捕获.\n- 资源清理规范: guard.dispose() MUST 放 finally,覆盖正常 done,超时,abort,异常等所有退出路径,避免 setInterval 泄漏.\n\n经验教训/避坑指南:\n- 半包处理: done=true 但 buffer.trim() 非空,说明连接异常中断残留半包,必须抛出可重试错误,禁止静默结束.\n- 错误识别最佳实践: 可重试判定优先使用 error.name === 'StreamIdleTimeoutError',避免依赖 message 关键字.\n- 注释规范: 只写\"为什么\"与竞态/边界风险点,禁止\"关键修复/新增\"等过程日志式注释.\n- 设计清理: wrapReaderWithIdleTimeout 因未使用且会引入双计时器竞态,应删除而非保留."
    },
    {
      "op": "update",
      "notebookId": "notebook-1770694883572_4ydxyl8k0",
      "previousNote": "职责: OpenAI Chat API 适配器,负责将内部 ChatMessage 格式转换为 OpenAI 消息格式,并实现 ChatCompletions 的流式 SSE 解析.\n接口摘要:\n- createStreamingChatCompletion(options,abortSignal,onRetry) -> AsyncGenerator<ChatCompletionChunk|...>.\n- parseSSEStream(reader,abortSignal?) 逐次 reader.read() 解码,解析 SSE data 行 JSON 并 yield.\n依赖拓扑:\n- 上游: 对话执行层(useConversation/summaryAgent 等)选择 Chat API.\n- 下游: withRetryGenerator(统一重试),utils/core/streamGuards(createIdleTimeoutGuard,StreamIdleTimeoutError),utils/core/retryUtils(stream interruption 分类),parseJsonWithFix,logger/proxy/version/usageLogger.\n\n架构要点(流式API保护模式):\n- MUST 接入 utils/core/streamGuards.ts 的 createIdleTimeoutGuard,统一实现 idle timeout(固定 180000ms) + abandoned 丢弃.\n- MUST 在 parseSSEStream 内部处理 abortSignal: abort 时调用 guard.abandon() 并 return,避免用户中断后延迟 chunk 外泄.\n- 竞态条件防护: 每次 reader.read() 后 MUST guard.touch();任何 yield 之前 MUST 检查 guard.isAbandoned();断开路径(用户 abort,空闲超时,网络异常,reader done)都要 abandon.\n- MUST 在读取循环中调用 guard.getTimeoutError() 检查并在循环上下文 throw,确保超时异常被 parseSSEStream 的 try/catch 捕获并进入 withRetryGenerator 重试.\n- 资源清理规范: guard.dispose() MUST 放 finally,避免定时器泄漏.\n\n经验教训/避坑指南:\n- 半包处理: done=true 且 buffer.trim() 非空说明残留半包,不应静默结束,应抛出可重试错误.\n- reader.cancel() 只是建议,不保证立即停止,必须依赖 guard.isAbandoned() 作为最终屏障.\n- 错误可重试判定优先使用 error.name(如 StreamIdleTimeoutError),降低对 error.message 关键字匹配的脆弱依赖.\n- 注释规范: 注释解释\"为什么\",禁止\"关键修复/新增\"等过程日志式注释.\n- 设计清理: wrapReaderWithIdleTimeout 因未使用且会引入双计时器竞态,应删除而非保留."
    },
    {
      "op": "update",
      "notebookId": "notebook-1770694883908_ow13cu46t",
      "previousNote": "职责: Google Gemini API 适配器,负责将内部 ChatMessage 格式转换为 Gemini 消息格式,并实现 Gemini 流式 SSE 读取与产出.\n接口摘要:\n- createStreamingGeminiCompletion(options,abortSignal,onRetry) -> AsyncGenerator<GeminiStreamChunk>.\n- SSE 读取循环通过 reader.read() 拼接 buffer,解析 data 行 JSON 并 yield(同时聚合 toolCallsBuffer/usage).\n依赖拓扑:\n- 上游: 对话执行层选择 Gemini 作为请求方法.\n- 下游: withRetryGenerator(统一重试),utils/core/streamGuards(createIdleTimeoutGuard,StreamIdleTimeoutError),utils/core/retryUtils(stream interruption 分类),parseJsonWithFix,logger/proxy/version/usageLogger.\n\n架构要点(流式API保护模式):\n- MUST 接入 utils/core/streamGuards.ts 的 createIdleTimeoutGuard,统一实现 idle timeout(固定 180000ms) + abandoned 丢弃.\n- MUST 在读取循环内处理 abortSignal,并将 abort 检查前置到 reader.read() 之前: abort 时调用 guard.abandon() 并 return,确保用户中断后旧连接延迟数据不外泄(与 chat/responses/anthropic 一致).\n- 竞态条件防护: 每次 reader.read() 后 MUST guard.touch();任何 yield/处理数据前 MUST 检查 guard.isAbandoned();断开后延迟消息必须被丢弃.\n- MUST 在读取循环中调用 guard.getTimeoutError() 检查并在循环上下文 throw,确保超时异常被 try/catch 捕获并进入 withRetryGenerator 重试.\n- 资源清理规范: guard.dispose() MUST 放 finally,避免定时器泄漏.\n\n经验教训/避坑指南:\n- 半包处理: done=true 且 buffer.trim() 非空说明残留半包,必须抛出可重试错误,不要静默结束.\n- reader.cancel() 可能无法立刻终止流,必须依赖 guard.isAbandoned() 兜底丢弃.\n- 错误可重试判定优先使用 error.name(如 StreamIdleTimeoutError),降低对 error.message 关键字的依赖.\n- 注释规范: 注释解释\"为什么\",禁止\"关键修复/新增\"等过程日志式注释.\n- 设计清理: wrapReaderWithIdleTimeout 因未使用且会引入双计时器竞态,应删除而非保留."
    },
    {
      "op": "update",
      "notebookId": "notebook-1770694883742_l9t553m1w",
      "previousNote": "职责: OpenAI Responses API 适配器,负责将内部 ChatMessage 格式转换为 Responses API 请求格式,并实现 Responses 流式 SSE 解析.\n接口摘要:\n- createStreamingResponse(options,abortSignal,onRetry) -> AsyncGenerator<ResponseStreamChunk>.\n- parseSSEStream(reader,abortSignal?) 逐次 reader.read() 解码,解析 SSE data 行 JSON 并 yield.\n依赖拓扑:\n- 上游: 对话执行层选择 Responses API.\n- 下游: withRetryGenerator,utils/core/streamGuards(createIdleTimeoutGuard,StreamIdleTimeoutError),utils/core/retryUtils(stream interruption 分类),parseJsonWithFix,proxy/version/usageLogger.\n\n架构要点(流式API保护模式):\n- MUST 接入 utils/core/streamGuards.ts 的 createIdleTimeoutGuard,统一实现 idle timeout(固定 180000ms) + abandoned 丢弃.\n- MUST 在 parseSSEStream 内部处理 abortSignal: abort 时调用 guard.abandon() 并 return,避免用户中断后延迟 chunk 外泄.\n- 竞态条件防护: 每次 reader.read() 后 MUST guard.touch();任何 yield 之前 MUST 检查 guard.isAbandoned();reader.cancel() 不可靠,guard.isAbandoned() 是最终屏障.\n- MUST 在读取循环中调用 guard.getTimeoutError() 检查并在循环上下文 throw,确保超时异常被 parseSSEStream 的 try/catch 捕获并进入 withRetryGenerator 重试.\n- 资源清理规范: guard.dispose() MUST 放 finally,避免定时器泄漏.\n\n经验教训/避坑指南:\n- 半包处理: done=true 但 buffer.trim() 非空时,说明连接异常中断残留半包,必须抛出可重试错误,否则下游会一直等\"结束事件\".\n- 错误识别最佳实践: 可重试判定优先使用 error.name === 'StreamIdleTimeoutError',避免依赖 error.message.includes(\"timeout\").\n- 注释规范: 注释应解释\"为什么\",而不是记录\"做了什么\".\n- 设计清理: wrapReaderWithIdleTimeout 因未使用且会引入双计时器竞态,应删除而非保留.\n- 本文件不引入 UI 或路由逻辑,保持 API 适配层纯度."
    }
  ],
  "296c4065-f81a-49ca-adbe-faf08e48c5b3:2": [
    {
      "op": "delete",
      "entry": {
        "id": "notebook-1771516802144_rjjhd9mej",
        "filePath": "CurrentTaskPlan.md",
        "note": "CurrentTaskPlan.md 微调建议(基于已定稿的新需求).\n\n现状:\n- CurrentTaskPlan.md 已完成与 requirements/全平台网页版Snow SSE客户端需求.md 的统一.\n- 但仍建议在计划书中显式固化 3 个实现要点,避免后续开发偏离.\n\n建议增补点:\n1) M0 增补 shared/errors 固化:\n- 除 shared/contracts 外,建议在 M0 明确固化 shared/errors(errorCode 枚举 + DomainError 结构),避免各层随意抛字符串.\n\n2) M1 增补 Auth 登录态实现建议(会话级):\n- 明确推荐使用 HttpOnly session cookie 且不设置 expires/max-age(浏览器关闭即失效).\n- 强调: login/me 返回口径固定 HTTP 200,不使用 401/403.\n\n3) M5 增补 Git status 口径:\n- 明确 status 的修改区必须包含: modified-unstaged + untracked + deleted-unstaged.\n- DiffViewer breakpoint 已在计划书中固化为 1200px,无需调整.\n\n说明:\n- 当前环境限制对 .md 文件编辑权限,因此以上建议以 notebook 形式记录,供主Agent或人工合入 CurrentTaskPlan.md.",
        "createdAt": "2026-02-20T00:00:02.144",
        "updatedAt": "2026-02-20T01:46:07.712"
      }
    },
    {
      "op": "add",
      "notebookId": "notebook-1771735800416_uz5vjb17k"
    },
    {
      "op": "add",
      "notebookId": "notebook-1771735800549_nrmgzgnnt"
    },
    {
      "op": "add",
      "notebookId": "notebook-1771735800708_5a84pzbvn"
    },
    {
      "op": "add",
      "notebookId": "notebook-1771735836915_9iyi2nqvn"
    },
    {
      "op": "add",
      "notebookId": "notebook-1771735837045_ax74drms8"
    },
    {
      "op": "add",
      "notebookId": "notebook-1771735859888_jrblgmfub"
    },
    {
      "op": "add",
      "notebookId": "notebook-1771735860039_agt0warvn"
    },
    {
      "op": "update",
      "notebookId": "notebook-1771495044055_cbcvm3sjp",
      "previousNote": "职责: API/HTTP 层.承载 Snow CLI 的对外 HTTP API 与第三方模型渠道适配器(source/api/*.ts).本层聚焦\"协议与适配\",不承载会话业务状态与 UI 逻辑.\n\n架构级原则(API 渠道冲突合并,SSoT: requirements/API渠道冲突合并需求文档.md):\n- 必须吸收 upstream:\n  1) 多条自定义系统提示词数组能力(用于特殊中转渠道兼容与可控性).\n  2) system/instruction 等字段映射增强语义,且 4 个适配器行为对齐.\n- 必须保留本地:\n  1) 主代理/子代理角色定义提示词严格隔离(禁止串扰/越权).\n  2) 特殊 user 消息动态\"后插\"能力(保持上下文顺序语义).\n  3) Responses API 多模态特殊处理与中转平台兼容路径.\n- 合并策略:\n  - 以\"能力并存\"代替\"二选一覆盖\".\n  - 先手动解冲突,再 build 验证;禁止借机做无关重构.\n  - 四文件系统提示词优先级,多条系统提示词注入方式,主/子代理隔离边界必须完全一致.\n\n统一系统提示词优先级规范(4 文件一致):\n1) 子代理调用且配置多条自定义系统提示词 -> 使用子代理自定义数组.\n2) 子代理调用且无自定义但有子代理角色定义提示词 -> 使用子代理角色定义.\n3) 主代理调用且配置多条自定义系统提示词 -> 使用主代理自定义数组.\n4) 无自定义系统提示词且允许内置 -> 使用对应代理的角色定义.\n5) 主/子代理自定义系统提示词处理规则必须一致,差异只能来自\"角色定义提示词来源\".\n\n主代理/子代理提示词隔离边界:\n- 角色定义提示词只来自各自 agent profile(主/子代理各自的角色定义配置),绝不跨注入.\n- 自定义系统提示词(customSystemPromptOverride)是\"调用侧\"显式传入,主/子代理能力等价,但只影响本次调用.\n\n多条自定义系统提示词支持规范:\n- 统一以 string[] 表达,保持顺序敏感(数组顺序即优先级/叠加顺序).\n- 四适配器对 customSystemPromptOverride 的参数类型与默认值语义保持一致,禁止单文件漂移.\n- 注入方式需兼容中转渠道: 允许把多个系统提示词拆分为多条 system 消息,或拼接为单条(由渠道约束决定),但\"语义一致,顺序一致\".\n\n特殊 user 消息后插语义规范:\n- 特殊 user 消息是对上下文的动态增强,必须插入到\"靠后位置\"(紧邻最新 user 或模型调用前约定位置),用于保持模型输出一致性.\n- 后插规则不得因系统提示词来源(主/子代理,自定义/角色定义)变化而丢失.\n\n多模态处理保留规范:\n- 必须保留对图片等多模态消息的特殊拆分/重写策略,目标: 兼容特殊中转平台与上游 Responses API 语义.\n- 禁止在本轮合并中将多模态路径回退为仅文本,或删除 tool_result/图片分离等兼容逻辑.\n\n实施顺序与验收门槛:\n- 顺序: anthropic.ts -> chat.ts -> gemini.ts -> responses.ts -> build.\n- 门槛: 4 文件无 conflict markers,提示词优先级一致,主/子代理隔离可追踪,后插能力与多模态兼容路径保留,npm run build 通过.\n\n常见错误与避坑清单:\n- 只在某一个适配器实现多系统提示词,导致调用层类型断裂.\n- 将主代理角色定义提示词注入到子代理请求(或反向)导致越权.\n- 拼接多系统提示词时丢失分隔/顺序,导致模型行为漂移.\n- 删除后插逻辑或改为前插,导致上下文语义变化.\n- 误删 Responses 多模态特殊处理(常见于解冲突时选择 upstream 版本).\n- 仅靠 reader.cancel() 期待停止流,忽略现有 streamGuards 竞态屏障(避免回归)."
    },
    {
      "op": "update",
      "notebookId": "notebook-1770694883398_3ow0urpes",
      "previousNote": "职责: Anthropic API 适配器.将内部 ChatMessage 转换为 Anthropic 消息格式,并实现 Anthropic 流式 SSE 解析与产出.\n\n接口摘要:\n- createStreamingAnthropicCompletion(options,abortSignal,onRetry) -> AsyncGenerator<AnthropicStreamChunk>.\n- parseSSEStream(reader,abortSignal?) 解析 SSE data 行 JSON 并 yield.\n\n合并蓝图(本轮 API 渠道冲突合并):\n- 本文件是 4 适配器的\"基准实现\".先在此处完成统一的系统提示词模型与参数签名,再同步到 chat/gemini/responses.\n\n系统提示词优先级(必须与其他 3 文件一致):\n1) 子代理调用且配置多条自定义系统提示词 -> 用子代理自定义数组.\n2) 子代理调用且无自定义但有子代理角色定义提示词 -> 用子代理角色定义.\n3) 主代理调用且配置多条自定义系统提示词 -> 用主代理自定义数组.\n4) 无自定义且允许内置 -> 用对应代理的角色定义.\n\n主/子代理提示词隔离边界:\n- 角色定义提示词只来自当前调用所属的代理(profile),禁止跨注入.\n- customSystemPromptOverride 作为调用侧显式输入,主/子代理能力等价,但不得覆盖隔离边界.\n\n多条自定义系统提示词支持规范:\n- customSystemPromptOverride 类型必须是 string[] (或可选),保持顺序敏感.\n- 注入方式需兼容特殊中转渠道: 允许多 system 消息或拼接为单 system,但必须跨 4 文件保持语义一致.\n\n特殊 user 消息后插语义规范:\n- 必须保留特殊 user 消息动态后插到上下文靠后位置的能力,其位置策略不得因系统提示词来源变化而改变.\n\n多模态处理保留规范:\n- 必须保留 tool_result 与图片分离等兼容处理,用于中转平台适配.\n\n流式 API 保护模式(既有约束,合并时不得破坏):\n- MUST 接入 createIdleTimeoutGuard(180000ms)+abandoned 丢弃.\n- abort 时 abandon 并 return,避免延迟 chunk 外泄.\n- done=true 但 buffer.trim() 非空必须抛可重试错误.\n\n避坑指南:\n- 解冲突时不要选择仅单字符串 systemPrompt 的上游/本地任一版本,必须合并为统一的多值能力.\n- 避免把主代理角色定义提示词误注入子代理请求(常见于共用变量名或默认值路径)."
    },
    {
      "op": "update",
      "notebookId": "notebook-1770694883572_4ydxyl8k0",
      "previousNote": "职责: OpenAI ChatCompletions API 适配器.负责消息格式转换与 ChatCompletions 流式 SSE 解析.\n\n接口摘要:\n- createStreamingChatCompletion(options,abortSignal,onRetry) -> AsyncGenerator<ChatCompletionChunk|...>.\n- parseSSEStream(reader,abortSignal?) 解析 SSE data 行 JSON 并 yield.\n\n统一合并规范(必须与 anthropic/gemini/responses 行为对齐):\n- 参数签名: customSystemPromptOverride 必须统一支持多条自定义系统提示词(string[]),主/子代理能力等价.\n- 系统提示词优先级: 完全遵循 requirements/API渠道冲突合并需求文档.md 中的 1-4 顺序,禁止单文件漂移.\n- 主/子代理隔离: 角色定义提示词严格隔离,不得互相污染.\n- 特殊 user 消息后插: 必须保留且位置策略一致.\n- 多模态兼容: 保留本地多模态消息转换增强,避免解冲突回退.\n\n中转渠道兼容目标:\n- 多系统提示词数组增强的目的在于适配特殊中转渠道.注入方式可因渠道约束变化,但\"多条输入,顺序敏感,语义一致\"必须保持.\n\n流式 API 保护模式(既有约束):\n- createIdleTimeoutGuard + abandoned 丢弃 + finally dispose.\n- done=true 且 buffer.trim() 非空必须抛可重试错误.\n\n避坑指南:\n- 不要把多系统提示词数组在此文件中拼接成单字符串,却在其他适配器保留数组系统消息,会导致行为不一致.\n- 处理 abort 时必须 abandon,不要只依赖 reader.cancel()."
    },
    {
      "op": "update",
      "notebookId": "notebook-1770694883908_ow13cu46t",
      "previousNote": "职责: Google Gemini API 适配器.将内部 ChatMessage 转换为 Gemini 消息格式,并实现 Gemini 流式 SSE 读取与产出.\n\n接口摘要:\n- createStreamingGeminiCompletion(options,abortSignal,onRetry) -> AsyncGenerator<GeminiStreamChunk>.\n\n统一合并规范(必须与 anthropic/chat/responses 对齐):\n- customSystemPromptOverride: 统一为多条自定义系统提示词数组能力(string[]),主/子代理能力等价.\n- 系统提示词优先级: 采用统一 1-4 优先级模型,禁止此文件单独改变 system 注入顺序.\n- 主/子代理隔离: 角色定义提示词仅来自当前调用代理,不得跨注入.\n- 特殊 user 消息后插: 必须保留动态后插语义,不得因 Gemini 特有消息结构而丢失.\n- 多模态兼容: 保留 Gemini 多模态与工具调用转换中的本地兼容增强,并与中转渠道目标一致.\n\n中转渠道兼容目标:\n- 多系统提示词数组增强用于特殊中转渠道兼容与可控性.在 Gemini 渠道中可能需要映射为等价字段,但必须保持\"多条输入,顺序敏感\".\n\n流式 API 保护模式(既有约束):\n- idle timeout guard(180000ms),abort abandon,done 残留半包抛错,finally dispose.\n\n避坑指南:\n- Gemini 的 message/parts 映射容易把 systemPrompt 与普通文本混淆,合并时要确保系统提示词路径与用户消息路径严格区分."
    },
    {
      "op": "update",
      "notebookId": "notebook-1770694883742_l9t553m1w",
      "previousNote": "职责: OpenAI Responses API 适配器.将内部 ChatMessage 转换为 Responses API 请求格式,并实现 Responses 流式 SSE 解析.\n\n接口摘要:\n- createStreamingResponse(options,abortSignal,onRetry) -> AsyncGenerator<ResponseStreamChunk>.\n\n本文件是本轮合并的\"最后一站\":\n- 必须在 anthropic/chat/gemini 完成统一模型后,再按同一模型合并此文件,避免 Responses 的 system/instruction 映射差异导致整体漂移.\n\n统一系统提示词优先级(4 文件一致):\n1) 子代理多条自定义系统提示词 -> 用子代理自定义数组.\n2) 子代理角色定义提示词.\n3) 主代理多条自定义系统提示词.\n4) 默认角色定义提示词.\n\nsystem/instruction 映射一致性规范:\n- 多条自定义系统提示词数组在 Responses 渠道中可能需要映射到 system 或 instruction,但必须与其他 3 文件保持等价语义,并保持顺序敏感.\n- 不得出现\"chat 用 system,responses 用 instruction 且丢失顺序\"之类的不一致.\n\n主/子代理隔离边界:\n- 角色定义提示词严格隔离,不得跨注入.\n- 主/子代理的自定义系统提示词处理规则必须一致,仅角色定义来源不同.\n\n特殊 user 消息后插语义规范:\n- 必须保留特殊 user 消息动态后插到上下文靠后位置的能力.\n\n多模态处理保留规范(本地不可覆盖点):\n- 必须保留本地 Responses API 多模态特殊处理路径,包括为了中转平台兼容而进行的图片消息特殊处理(例如图片拆分为独立 user 消息等策略).\n- 解冲突时优先保留本地多模态链路,再把 upstream 的多系统提示词数组能力嵌入该链路,禁止反向覆盖.\n\n流式 API 保护模式(既有约束):\n- parseSSEStream 内 abort abandon,guard.touch/isAbandoned,timeout error throw,finally dispose.\n\n避坑指南:\n- Responses 最容易在解冲突时被 upstream 覆盖掉本地多模态处理,必须显式比对保留.\n- 注意 tool_result/图片等多模态与系统提示词注入的相对顺序,避免改变上下文语义."
    },
    {
      "op": "add",
      "notebookId": "notebook-1771735952610_uwnsmpo44"
    },
    {
      "op": "delete",
      "entry": {
        "id": "notebook-1771735952610_uwnsmpo44",
        "filePath": "CurrentTaskPlan.md",
        "note": "职责: 短线开发任务计划书.仅描述\"下一阶段要做什么\"(可执行的任务分解,验收标准,风险与回滚),不沉淀长期架构.\n\n使用规范:\n- 仅在存在明确短期需求/合并冲突解决任务时更新.\n- 完成后应删除或归档其 notebook 记录,避免把过程性计划留在蓝图中.\n\n避坑指南:\n- 计划必须指向 requirements/* 的 SSoT 文档,避免计划本身成为需求来源.\n- 计划项必须可验收(有 build 通过,或明确的行为检查点).",
        "createdAt": "2026-02-22T12:52:32.610",
        "updatedAt": "2026-02-22T12:52:32.610"
      }
    },
    {
      "op": "add",
      "notebookId": "notebook-1771735962484_dpvy47imp"
    },
    {
      "op": "add",
      "notebookId": "notebook-1771735973924_t53il5lc3"
    },
    {
      "op": "add",
      "notebookId": "notebook-1771735974038_b0q52xqaa"
    },
    {
      "op": "add",
      "notebookId": "notebook-1771735983400_at2zw7mca"
    },
    {
      "op": "add",
      "notebookId": "notebook-1771735997275_zjuil6i5h"
    }
  ],
  "d0154740-e45d-48b0-bd12-6c5f70522950:88": [
    {
      "op": "add",
      "notebookId": "notebook-1771993976867_1m6jwnx2a"
    }
  ],
  "1ffb424d-02ce-49b5-80e2-1f0bc519267e:68": [
    {
      "op": "update",
      "notebookId": "notebook-1770864631004_fsmcp",
      "previousNote": "职责: 文件编辑真实执行层,承载 editableFileSuffixes 拦截规则的统一落点.\n接口摘要: editFile/editFileBySearch 支持单文件与批量,输出 diff,diagnostics 与统计结果.\n依赖拓扑: 上游由 mcpToolsManager.ts 调用,批量聚合依赖 batch-operations.utils.ts.\n避坑指南:\n- 本层保持纯执行语义,不参与任何 UI 导航(showMcpPanel,mcpPanelSource,source)决策.\n- 拒绝项在批量中落成 success:false + 固定文案,保留部分成功.\n- 工具执行前应同时受\"MCP 服务开关(全局总闸)\"与\"代理工具权限(代理分闸)\"影响.\n- 服务级禁用应在 mcpToolsManager/disabledBuiltInTools 形成不可路由的最终集合,本层只对已授权且已启用的工具执行,不负责读取/写入全局禁用文件.\n- 与本需求相关: 流式 API idle timeout/断开丢弃属于网络请求层与 utils/core 的职责,不得在工具执行层实现任何与 HTTP/stream 相关的超时或重试,避免跨域耦合."
    },
    {
      "op": "add",
      "notebookId": "notebook-1771996324726_vs2l8pyge"
    },
    {
      "op": "add",
      "notebookId": "notebook-1771996324843_ikiijl0dw"
    }
  ],
  "1ffb424d-02ce-49b5-80e2-1f0bc519267e:136": [
    {
      "op": "update",
      "notebookId": "notebook-1771996324726_vs2l8pyge",
      "previousNote": "职责: ACE 文本/语义检索服务与 MCP 工具定义提供者.本次需求下需要为 ace-text_search 输出可被编辑工具稳定引用的命中标识(resultId/resultHash 等).\n\n接口摘要:\n- 输入: pattern,fileGlob,isRegex,maxResults.\n- 输出: 搜索命中列表(文件,行列,内容) + 可引用标识(用于后续 filesystem-edit_search 联动).\n- 工具描述需前置说明: 搜索结果可直接驱动后续替换.\n\n依赖拓扑:\n- 下游: source/mcp/filesystem.ts 的 filesystem-edit_search 联动模式消费其引用标识.\n- 同层: source/mcp/mcpToolsManager.ts 汇总工具描述与路由.\n\n避坑指南:\n- 引用标识必须在单次调用结果内可唯一定位到命中项,避免跨结果歧义.\n- 不做跨会话持久化缓存承诺,仅满足当前调用链路联动.\n- 提示词改造目标是\"联动优先 + 精简\",避免继续堆叠长篇示例."
    },
    {
      "op": "update",
      "notebookId": "notebook-1770864631004_fsmcp",
      "previousNote": "职责: 文件编辑真实执行层,承载 editableFileSuffixes 拦截与 filesystem-edit_search 的两种执行模式(联动引用模式,传统 searchContent 模式)的统一落点.\n\n接口摘要:\n- 输入: 单文件/批量文件参数.\n- 输出: diff,diagnostics,批量统计.\n- 新约束: 当请求携带 searchResultId/searchResultHash 时进入联动引用模式,由引用结果定位替换目标,不要求手填 searchContent.\n\n依赖拓扑:\n- 上游: mcpToolsManager.ts 路由工具调用.\n- 依赖: source/mcp/utils/filesystem/batch-operations.utils.ts 做批量聚合.\n- 协作: source/mcp/aceCodeSearch.ts 负责产出可引用的搜索结果标识.\n\n避坑指南:\n- 联动引用模式下 MUST 禁止回落 fuzzy 匹配路径,避免误匹配.\n- 引用结果失效或内容不匹配时,沿用现有匹配失败语义,不要引入新错误流程分叉.\n- 保持兼容: 传统 searchContent + replaceContent 继续可用.\n- 本层保持纯执行语义,不做 UI 导航与 HTTP/stream 超时重试逻辑.\n- 拒绝项在批量中保持 success:false + 固定文案,允许部分成功."
    },
    {
      "op": "add",
      "notebookId": "notebook-1771996532767_mqtzr0qtq"
    }
  ],
  "208d2d4d-124c-45c6-b97c-20fe0a742a6e:45": [
    {
      "op": "update",
      "notebookId": "notebook-1770864631004_fsmcp",
      "previousNote": "职责: 文件编辑执行层,承载 filesystem-edit_search 的双模式落地(联动引用模式,传统 searchContent 模式),并统一输出 diff 与诊断.\n\n接口摘要:\n- 输入: 单文件/批量文件参数,新增联动参数 searchResultId/searchResultHash(任选其一).\n- 输出: 编辑结果,批量统计,失败信息(沿用现有匹配失败语义).\n- 规则: 联动参数存在时优先进入引用模式,无需手填 searchContent.\n\n依赖拓扑:\n- 上游: mcpToolsManager.ts 工具路由.\n- 上游数据: ace-text_search 返回的可引用搜索命中.\n- 依赖: source/mcp/utils/filesystem/batch-operations.utils.ts 做批量聚合.\n\n避坑指南:\n- 联动引用模式下 MUST 禁止 fuzzy 路径,避免误匹配.\n- 引用失效或目标内容变化时,沿用当前匹配失败逻辑,不新增专用过期流程.\n- 保持兼容: 传统 searchContent + replaceContent 行为不回退.\n- 批量场景保持逐项隔离失败,不要因单项失败中断全批次."
    },
    {
      "op": "update",
      "notebookId": "notebook-1771996324726_vs2l8pyge",
      "previousNote": "职责: ACE 检索服务与 MCP 工具定义提供者.本需求下 ace-text_search 需要产出可被 filesystem-edit_search 立即消费的稳定引用标识(searchResultId/searchResultHash),并在工具描述中前置联动优先 workflow.\n\n接口摘要:\n- 输入: pattern,fileGlob,isRegex,maxResults.\n- 输出: 搜索命中列表(文件,行,列,内容) + 引用标识(至少一类可唯一引用当前命中项).\n- 文案: 强调\"搜索结果可直接用于后续替换\",并建议要改文件时先新搜索再立即消费引用结果.\n\n依赖拓扑:\n- 下游: source/mcp/filesystem.ts 的 filesystem-edit_search 联动模式消费引用标识.\n- 同层: source/mcp/mcpToolsManager.ts 汇总工具描述与路由.\n- 辅助: source/mcp/utils/aceCodeSearch/search.utils.ts 提供结果规范化与解析支持.\n\n避坑指南:\n- 引用标识必须在单次搜索结果内稳定且可唯一定位,避免多命中歧义.\n- 不承诺跨会话持久化结果缓存,仅保证同轮调用链路可引用.\n- 联动优先不等于强制替代,旧输出结构应保持向后兼容.\n- 提示词改造要精简,避免继续堆叠冗长示例."
    },
    {
      "op": "update",
      "notebookId": "notebook-1771996324843_ikiijl0dw",
      "previousNote": "职责: 文件批量执行公共执行器,仅负责 parse->逐项执行->结果聚合.\n\n接口摘要:\n- 输入: parseParams,executeSingle,mapResult.\n- 输出: results,totalFiles,successCount,failureCount 及汇总文案.\n\n依赖拓扑:\n- 被 source/mcp/filesystem.ts 的 editFile 与 editFileBySearch 复用.\n\n避坑指南:\n- 禁止在本层注入联动引用解析逻辑,联动/传统模式判定应留在 filesystem.ts 或其专属解析层.\n- 保持工具无关中立性,不要耦合 ace-text_search 结果结构细节.\n- 批量失败语义保持逐项隔离,不可因单项失败中断全批次."
    },
    {
      "op": "update",
      "notebookId": "notebook-1770950000005_mcptoolsmanager",
      "previousNote": "职责: MCP 工具管理核心,管理内置服务与外部 MCP 服务的注册,发现,调用与状态聚合,向执行层提供统一的工具视图.\n不该做什么:\n- 不引入 UI 导航状态(showMcpPanel,mcpPanelSource,source)或 screen/panel 概念.\n- 不在此处实现配置 UI,仅提供可被 UI 消费的状态与操作 API.\n接口摘要:\n- 输入: MCP 服务配置(mcp.json/内置 hardcoded 列表),以及工具调用请求(tool name + args + context).\n- 输出: 可用工具列表,服务状态(连接/错误),工具执行结果.\n依赖拓扑:\n- 依赖: disabledBuiltInTools(内置服务启用状态),mcpConfig(外部服务配置).\n- 被依赖: MCPInfoPanel(服务状态/重连/开关),toolExecutor(执行转发),各 Agent(工具发现与执行).\n关键架构决策:\n- 内置服务列表 hardcoded: 新增/调整内置服务必须修改本文件并同步 disabledBuiltInTools 的服务名约束.\n- 统一维护\"服务 <-> 工具\"映射关系,并在此处裁剪被禁用服务对应的工具集合.\n避坑指南:\n- 服务禁用状态需同时检查 disabledBuiltInTools,避免只隐藏 UI 但执行仍可调用.\n- 切换服务启用/禁用后应刷新/重建工具缓存,确保运行态与 UI 一致.\n- 外部服务与内置服务禁用逻辑不同,不要混用配置文件.\n备注:\n- 与\"流式 API 空闲超时/断开后丢弃\"无关.该机制属于 api adapters + utils/core(streamGuards,retryUtils),并且固定 3 分钟不可配置.本文件只需透传 abortSignal 与执行请求,避免把网络健壮性与工具编排耦合."
    },
    {
      "op": "add",
      "notebookId": "notebook-1771999700459_0s53bq6vd"
    },
    {
      "op": "add",
      "notebookId": "notebook-1771999700664_2i16r0tft"
    },
    {
      "op": "add",
      "notebookId": "notebook-1771999700862_umge919mv"
    }
  ],
  "6bbe3331-5593-4d14-8acd-955fb1e0eb0a:226": [
    {
      "op": "update",
      "notebookId": "notebook-1771996532767_mqtzr0qtq",
      "previousNote": "职责: ace 文本搜索的底层工具与结果规范化辅助层.本需求下负责支持联动引用所需的结果标识生成或解析辅助(若该职责落在本文件).\n\n接口摘要:\n- 输入: 搜索原始输出(文件,行列,内容)与匹配参数.\n- 输出: 标准化结果字段与可复算标识(searchResultHash 等)所需工具函数.\n\n依赖拓扑:\n- 被 source/mcp/aceCodeSearch.ts 调用,用于构建 ace-text_search 返回结构.\n- 间接服务于 source/mcp/filesystem.ts 的联动定位.\n\n避坑指南:\n- 标识算法需确定性,避免受运行环境差异影响.\n- 仅做纯函数转换/解析,不要耦合 I/O 与业务流程控制.\n- 若新增哈希字段,需同步文案与类型定义,保持输出契约一致."
    },
    {
      "op": "update",
      "notebookId": "notebook-1771996324726_vs2l8pyge",
      "previousNote": "职责: ACE 检索服务与 MCP 工具定义提供者.ace-text_search 产出可被 filesystem-edit_search 直接消费的 searchResultId,作为联动入口.\n\n接口摘要:\n- 输入: pattern,fileGlob,isRegex,maxResults.\n- 输出: 搜索命中(文件,行,列,内容) + searchResultId.\n- 文案: 明确联动优先工作流,引导先搜索再替换.\n\n依赖拓扑:\n- 下游: source/mcp/filesystem.ts 消费 searchResultId 执行联动替换.\n- 同步约束: source/mcp/types/aceCodeSearch.types.ts 与工具 schema 描述保持一致.\n- 同层协同: source/utils/execution/mcpToolsManager.ts 的提示文案与参数透传.\n\n避坑指南:\n- 协议收敛后仅对外暴露 searchResultId,禁止恢复 hash 并行能力.\n- 工具描述,schema,实现返回字段必须三方同步,避免文案/校验/透传漂移.\n- 不承诺跨会话持久化引用,仅保证当前运行态可用."
    },
    {
      "op": "update",
      "notebookId": "notebook-1770864631004_fsmcp",
      "previousNote": "职责: 文件编辑执行层,承载 filesystem-edit_search 的两条路径(联动引用模式,传统 searchContent 模式),统一输出 diff 与失败语义.\n\n接口摘要:\n- 输入: 单文件/批量参数.单文件 replaceContent 必填,搜索目标二选一(searchResultId 或 searchContent).\n- 输出: 编辑结果,批量统计,失败信息.\n- 规则: 联动模式优先工作流为先 ace-text_search,后 filesystem-edit_search(searchResultId+replaceContent).\n\n依赖拓扑:\n- 上游: source/utils/execution/mcpToolsManager.ts 的参数校验与透传.\n- 上游数据: source/mcp/aceCodeSearch.ts 返回的 searchResultId.\n- 依赖: source/mcp/utils/searchResultReferenceStore.ts 做引用查询.\n- 依赖: source/mcp/utils/filesystem/batch-operations.utils.ts 做批量聚合.\n\n避坑指南:\n- 联动模式 MUST NOT 走 fuzzy 匹配路径,失败沿用 Search content not found in file.\n- 协议已收敛为仅 searchResultId,禁止重新引入 searchResultHash 或双轨并行协议.\n- 兼容模式(searchContent)保留,但不得影响联动模式判定与错误语义."
    }
  ]
}